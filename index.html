<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FarmGuru AI — Intelligent Crop Advisory System</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Leaflet (maps) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary: #059669;
      --primary-dark: #047857;
      --secondary: #F59E0B;
      --accent: #10B981;
      --muted: #64748b;
      --danger: #EF4444;
      --warning: #F59E0B;
      --success: #10B981;
    }
    
    body {
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 600;
      border: none;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(5, 150, 105, 0.25);
    }
    
    .btn-outline {
      background: white;
      border: 1px solid #e6e9ef;
      padding: 10px 16px;
      border-radius: 10px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    
    .btn-outline:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .input {
      width: 100%;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #e6e9ed;
      transition: all 0.2s ease;
    }
    
    .input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
    }
    
    .tab-btn {
      padding: 8px 16px;
      border: none;
      background: transparent;
      font-weight: 600;
      color: #334155;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    
    .tab-btn:hover {
      color: var(--primary);
    }
    
    .tab-active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    
    #previewWrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.35s ease;
      border-radius: 12px;
    }
    
    #previewWrap img:hover {
      transform: scale(1.03);
    }
    
    body.dark {
      background: linear-gradient(180deg, #0b0384, #b30376);
      color: #dbeadf;
    }
    
    body.dark .bg-white {
      background: rgba(255, 255, 255, 0.05) !important;
      border: 1px solid rgba(255, 255, 255, 0.1);
    } 
    
    .small-muted {
      font-size: 12px;
      color: var(--muted);
    }
    
    .badge {
      background: #ecfdf5;
      color: #065f46;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 12px;
    }
    
    .severity-indicator {
      height: 8px;
      border-radius: 4px;
      background: #e5e7eb;
      overflow: hidden;
    }
    
    .severity-fill {
      height: 100%;
      transition: width 0.5s ease;
    }
    
    .weather-card {
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      color: white;
      border-radius: 12px;
      padding: 16px;
    }
    
    .pesticide-card {
      border-left: 4px solid var(--accent);
      padding-left: 16px;
    }
    
    .crop-calendar-day {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .crop-calendar-day.active {
      background: var(--accent);
      color: white;
    }
    
    .crop-calendar-day.today {
      border: 2px solid var(--accent);
    }
    
    .market-price-trend {
      height: 40px;
      width: 100%;
      position: relative;
    }
    
    .market-price-line {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent);
    }
    
    /* Chatbot Styles */
    .chat-container {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 380px;
      height: 500px;
      background: white;
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      z-index: 1000;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .chat-header {
      background: var(--primary);
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top-left-radius: 18px;
      border-top-right-radius: 18px;
    }
    
    .chat-messages {
      flex: 1;
      padding: 16px 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #f8fafc;
    }
    
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.4;
      font-size: 14px;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .bot-message {
      background: white;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .user-message {
      background: var(--primary);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      box-shadow: 0 2px 8px rgba(5, 150, 105, 0.2);
    }
    
    .chat-input-container {
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 10px;
      background: #f9fafb;
    }
    
    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      outline: none;
      font-size: 14px;
    }
    
    .chat-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 16px rgba(5, 150, 105, 0.3);
      cursor: pointer;
      z-index: 1001;
      transition: all 0.3s ease;
    }
    
    .chat-toggle:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(5, 150, 105, 0.4);
    }
    
    .voice-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--muted);
      padding: 6px;
      border-radius: 50%;
      transition: all 0.2s ease;
    }
    
    .voice-btn:hover {
      background: #f1f5f9;
      color: var(--primary);
    }
    
    .voice-btn.listening {
      background: #fee2e2;
      color: var(--danger);
      animation: pulse 1.5s infinite;
    }
    
    .lang-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      transition: all 0.2s ease;
    }
    
    .lang-btn.active {
      background: white;
      color: var(--primary);
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    /* Dashboard Cards */
    .dashboard-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }
    
    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    }
    
    /* Progress Animation */
    @keyframes progress {
      0% { background-position: 0 0; }
      100% { background-position: 40px 0; }
    }
    
    .progress-bar {
      height: 8px;
      border-radius: 4px;
      background-color: #e5e7eb;
      overflow: hidden;
    }
    
    .progress-bar-fill {
      height: 100%;
      border-radius: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      background-size: 40px 100%;
      animation: progress 1s linear infinite;
    }
    
    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 10px;
      background: white;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 2000;
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }
    
    .notification-success {
      border-left: 4px solid var(--success);
    }
    
    .notification-error {
      border-left: 4px solid var(--danger);
    }
    
    .notification-warning {
      border-left: 4px solid var(--warning);
    }
    
    /* Responsive */
    @media (max-width: 1024px) {
      .grid-cols-3 {
        grid-template-columns: 1fr 1fr !important;
      }
    }
    
    @media (max-width: 768px) {
      .grid-cols-3 {
        grid-template-columns: 1fr !important;
      }
      
      .chat-container {
        right: 10px;
        bottom: 80px;
        width: calc(100% - 20px);
        height: 65%;
      }
      
      .chat-toggle {
        bottom: 10px;
        right: 10px;
        width: 56px;
        height: 56px;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-b from-green-50 to-emerald-100 min-h-screen text-slate-800">
  <!-- Notification System -->
  <div id="notification" class="notification hidden">
    <i id="notificationIcon" class="fas fa-info-circle"></i>
    <div>
      <div id="notificationTitle" class="font-semibold"></div>
      <div id="notificationMessage" class="text-sm"></div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto p-6">
    <!-- Header -->
    <header class="flex flex-wrap items-center justify-between gap-4 mb-8">
      <div class="flex items-center gap-4">
        <div class="rounded-2xl bg-emerald-700 p-3 text-white shadow-lg">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M3 21s7-4 10-8 4-8 4-8-6.5 0-11 4S3 21 3 21z" fill="white"></path></svg>
        </div>
        <div>
          <h1 class="text-2xl md:text-3xl font-bold">FarmGuru AI</h1>
          <p class="small-muted">Intelligent Crop Advisory System · Hackathon Prototype</p>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div id="onlineBadge" class="flex items-center gap-2 px-3 py-1 rounded-full border bg-white/70 shadow-sm">
          <span id="onlineDot" class="h-3 w-3 rounded-full bg-emerald-500 block"></span>
          <span id="onlineText" class="text-sm">Online</span>
        </div>

        <select id="langSelect" class="rounded-lg border px-3 py-1 bg-white">
          <option value="en">English</option>
          <option value="hi">हिंदी</option>
          <option value="ta">தமிழ்</option>
          <option value="te">తెలుగు</option>
        </select>

        <button id="shareBtn" class="px-4 py-2 rounded-lg bg-emerald-600 text-white shadow flex items-center gap-2">
          <i class="fas fa-share-alt"></i> Share
        </button>
      </div>
    </header>

    <!-- Dashboard Stats -->
    <div class="grid grid-cols-4 gap-4 mb-6">
      <div class="dashboard-card flex items-center gap-4">
        <div class="p-3 rounded-xl bg-emerald-100 text-emerald-700">
          <i class="fas fa-leaf text-xl"></i>
        </div>
        <div>
          <div class="text-sm text-slate-500">Detections Today</div>
          <div class="text-2xl font-bold">12</div>
        </div>
      </div>
      
      <div class="dashboard-card flex items-center gap-4">
        <div class="p-3 rounded-xl bg-amber-100 text-amber-700">
          <i class="fas fa-exclamation-triangle text-xl"></i>
        </div>
        <div>
          <div class="text-sm text-slate-500">Disease Alerts</div>
          <div class="text-2xl font-bold">3</div>
        </div>
      </div>
      
      <div class="dashboard-card flex items-center gap-4">
        <div class="p-3 rounded-xl bg-blue-100 text-blue-700">
          <i class="fas fa-cloud-sun text-xl"></i>
        </div>
        <div>
          <div class="text-sm text-slate-500">Weather Index</div>
          <div class="text-2xl font-bold">72%</div>
        </div>
      </div>
      
      <div class="dashboard-card flex items-center gap-4">
        <div class="p-3 rounded-xl bg-purple-100 text-purple-700">
          <i class="fas fa-rupee-sign text-xl"></i>
        </div>
        <div>
          <div class="text-sm text-slate-500">Market Trends</div>
          <div class="text-2xl font-bold">+5.2%</div>
        </div>
      </div>
    </div>

    <!-- Layout -->
    <div class="grid grid-cols-3 gap-6">
      <!-- LEFT: Capture & Controls -->
      <div class="col-span-1 space-y-6">
        <div class="dashboard-card">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-semibold text-lg" id="leftTitle">Crop Health Analysis</h2>
            <span class="small-muted">AI-powered detection</span>
          </div>

          <div id="previewWrap" class="w-full h-64 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200 flex items-center justify-center overflow-hidden mb-4 cursor-pointer">
            <div id="previewPlaceholder" class="text-center p-4">
              <i class="fas fa-cloud-upload-alt text-3xl text-slate-400 mb-2"></i>
              <p class="text-sm text-slate-400">Click to upload or drag & drop</p>
            </div>
          </div>

          <div class="flex gap-2 mb-4">
            <input id="fileInput" type="file" accept="image/*" class="hidden" />
            <button id="btnUpload" class="btn-primary flex-1">
              <i class="fas fa-upload"></i> Upload Image
            </button>
            <button id="btnSample" class="btn-outline">
              <i class="fas fa-vial"></i> Use Sample
            </button>
          </div>

          <div class="mb-4">
            <label class="text-sm font-medium block mb-2">Crop Type</label>
            <select id="cropInput" class="input">
              <option value="">Select crop type</option>
              <option value="Tomato">Tomato</option>
              <option value="Potato">Potato</option>
              <option value="Rice">Rice</option>
              <option value="Wheat">Wheat</option>
              <option value="Cotton">Cotton</option>
              <option value="Sugarcane">Sugarcane</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="mb-4">
          <label class="text-sm font-medium block mb-2">Confidence threshold: <span id="confLabel">70%</span></label>
            <input id="confRange" type="range" min="50" max="95" value="70" class="w-full" /> -->
          </div>

          <div class="flex items-center justify-between gap-3 mb-4">
            <label class="flex items-center gap-2 text-sm cursor-pointer">
              <input id="consent" type="checkbox" checked class="rounded"/>
              <span id="consentLabel">Allow anonymous learning</span>
            </label>
            <button id="btnDetect" class="btn-primary">
              <i class="fas fa-magic"></i> Detect Issues
            </button>
          </div>

          <div id="progressWrap" class="mt-4 hidden">
            <div class="text-xs text-slate-500 mb-2 flex justify-between">
              <span id="progressText">Running on-device model…</span>
              <span id="progressPercent">0%</span>
            </div>
            <div class="progress-bar">
              <div id="progressBar" class="progress-bar-fill w-0"></div>
            </div>
          </div>
        </div>

        <!-- Weather Forecast Widget -->
        <div class="dashboard-card">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold">Weather Forecast</h3>
            <div class="text-xs text-slate-500" id="weatherLocation">Lucknow, UP</div>
          </div>
          <div id="weatherContainer" class="space-y-3">
            <div class="weather-card">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-2xl font-bold" id="currentTemp">32°C</div>
                  <div class="text-sm" id="weatherCondition">Partly Cloudy</div>
                </div>
                <div class="text-right">
                  <div class="text-sm">Humidity: <span id="weatherHumidity">65%</span></div>
                  <div class="text-sm">Rain: <span id="weatherRain">10%</span></div>
                </div>
              </div>
            </div>
            <div class="flex justify-between text-xs text-center">
              <div class="px-2">
                <div>Today</div>
                <div class="font-semibold">32°</div>
              </div>
              <div class="px-2">
                <div>Tomorrow</div>
                <div class="font-semibold">34°</div>
              </div>
              <div class="px-2">
                <div>Wed</div>
                <div class="font-semibold">33°</div>
              </div>
              <div class="px-2">
                <div>Thu</div>
                <div class="font-semibold">31°</div>
              </div>
            </div>
          </div>
          <div class="mt-3 text-xs text-slate-500" id="weatherAdvice">Good weather for spraying treatments.</div>
        </div>

        <div class="dashboard-card space-y-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Session Stats</h3>
            <div class="text-xs text-slate-500">Realtime</div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="p-3 rounded-lg bg-emerald-50">
              <div class="text-sm text-slate-600">Detections</div>
              <div id="statDetections" class="text-xl font-bold">0</div>
            </div>
            <div class="p-3 rounded-lg bg-amber-50">
              <div class="text-sm text-slate-600">Flags</div>
              <div id="statFlags" class="text-xl font-bold">0</div>
            </div>
          </div>

          <div>
            <h4 class="text-sm font-medium mb-2">History</h4>
            <div id="historyList" class="max-h-36 overflow-auto space-y-2 text-sm"></div>
            <div class="flex gap-2 mt-3">
              <button id="btnExportCSV" class="btn-outline flex-1">
                <i class="fas fa-file-csv"></i> Export CSV
              </button>
              <button id="btnClearHistory" class="btn-outline text-red-600">
                <i class="fas fa-trash"></i> Clear
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- MIDDLE: Results & Tabs -->
      <div class="col-span-1 space-y-6">
        <div class="dashboard-card">
          <div class="flex items-start justify-between">
            <div>
              <h3 class="font-semibold text-lg" id="resultsHeading">Result & Advisory</h3>
              <p id="resultSub" class="text-sm text-slate-500">Upload & detect to see result</p>
            </div>
            <div id="badges" class="flex flex-col items-end gap-2"></div>
          </div>

          <div id="resultCard" class="mt-4 hidden">
            <div class="flex items-center gap-3 mb-4">
              <div id="detectedName" class="font-semibold text-emerald-700 text-lg"></div>
              <div id="tagCrop" class="badge"></div>
              <div id="tagConf" class="badge bg-blue-100 text-blue-800"></div>
              <button id="btnSpeak" class="ml-auto btn-outline">
                <i class="fas fa-volume-up"></i> Speak
              </button>
            </div>

            <!-- Disease Severity Indicator -->
            <div class="mb-4">
              <div class="flex items-center justify-between mb-1">
                <span class="text-sm font-medium">Disease Severity</span>
                <span class="text-xs" id="severityValue">Moderate (45%)</span>
              </div>
              <div class="severity-indicator">
                <div id="severityFill" class="severity-fill bg-amber-500" style="width: 45%"></div>
              </div>
            </div>

            <div>
              <div class="flex gap-2 border-b pb-2 overflow-x-auto">
                <button class="tab-btn tab-active" data-tab="advisory">
                  <i class="fas fa-lightbulb"></i> Advisory
                </button>
                <button class="tab-btn" data-tab="symptoms">
                  <i class="fas fa-stethoscope"></i> Symptoms
                </button>
                <button class="tab-btn" data-tab="stores">
                  <i class="fas fa-store"></i> Nearby Stores
                </button>
                <button class="tab-btn" data-tab="pesticide">
                  <i class="fas fa-calculator"></i> Spray Calculator
                </button>
              </div>

              <div id="tabContent" class="mt-3">
                <div id="advisory" class="tab-pane">
                  <ul id="advList" class="list-disc pl-5 space-y-2"></ul>
                </div>
                <div id="symptoms" class="tab-pane hidden">
                  <ul id="symList" class="list-disc pl-5 space-y-2"></ul>
                </div>
                <div id="stores" class="tab-pane hidden">
                  <div id="storesList"></div>
                  <div id="map" class="w-full h-40 rounded-xl mt-3 border"></div>
                </div>
                <div id="pesticide" class="tab-pane hidden">
                  <div class="text-sm mb-3">Calculate required pesticide quantity for your field</div>
                  <div class="space-y-3">
                    <div>
                      <label class="text-sm font-medium">Field Area (acres)</label>
                      <input type="number" id="fieldArea" class="input mt-1" placeholder="e.g., 2.5" value="1" min="0.1" step="0.1">
                    </div>
                    <div>
                      <label class="text-sm font-medium">Recommended dosage</label>
                      <input type="text" id="recommendedDosage" class="input mt-1 bg-gray-100" value="2g/L" readonly>
                    </div>
                    <div class="pesticide-card bg-slate-50 p-3 rounded-lg">
                      <div class="text-sm font-medium">You will need approximately:</div>
                      <div id="pesticideResult" class="font-bold text-lg mt-1">200g</div>
                      <div class="text-xs text-slate-500 mt-1">For spraying at 200L/acre</div>
                    </div>
                    <button id="btnCalculatePesticide" class="btn-primary w-full">
                      <i class="fas fa-calculator"></i> Calculate
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 gap-3 mt-4">
              <textarea id="notes" placeholder="Notes (field, spray dates)" class="input h-24"></textarea>
              <div class="flex gap-2">
                <button id="btnPdf" class="btn-primary flex-1">
                  <i class="fas fa-file-pdf"></i> Download PDF
                </button>
                <button id="btnFlag" class="btn-outline">
                  <i class="fas fa-flag"></i> Flag wrong detection
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Crop Calendar Widget -->
        <div class="dashboard-card">
          <div class="flex items-center justify-between mb-4">
            <h4 class="font-medium">Crop Calendar</h4>
            <div class="text-xs text-slate-500" id="currentMonth">August 2023</div>
          </div>
          <div class="grid grid-cols-7 gap-1 text-xs text-center mb-2">
            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
          </div>
          <div class="grid grid-cols-7 gap-1" id="cropCalendar">
            <!-- Calendar will be generated by JavaScript -->
          </div>
          <div class="mt-3 text-xs text-slate-500" id="calendarNote">Click on dates to mark important events</div>
        </div>

        <div class="dashboard-card">
          <div class="flex items-center justify-between">
            <div>
              <h4 class="font-medium">Advanced</h4>
              <p class="text-xs text-slate-500">Experimental features</p>
            </div>
            <label class="flex items-center gap-2 text-sm cursor-pointer">
              <input id="darkToggle" type="checkbox" />
              <span>Dark UI</span>
            </label>
          </div>

          <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
            <button id="btnShareAdvisory" class="btn-outline">
              <i class="fas fa-share"></i> Share Advisory
            </button>
            <button id="btnSaveImage" class="btn-outline">
              <i class="fas fa-save"></i> Save Image
            </button>
            <button id="btnAnalyze" class="btn-primary">
              <i class="fas fa-chart-line"></i> Generate Report
            </button>
            <button id="btnApiSim" class="btn-outline">
              <i class="fas fa-cloud-upload-alt"></i> Simulate Upload
            </button>
          </div>
        </div>
      </div>

         <!-- RIGHT: Analytics & Pitch -->
      <div class="col-span-1 space-y-6">
        <div class="dashboard-card">
          <h4 class="font-medium mb-4">Analytics</h4>
          <div class="h-48 relative"> <!-- Added wrapper with fixed height -->
            <canvas id="diseaseChart"></canvas>
          </div>
          <div class="mt-4 grid grid-cols-2 gap-3">
            <div class="p-3 rounded-lg bg-emerald-50">
              <div class="text-xs text-slate-600">Avg Confidence</div>
              <div id="avgConf" class="text-lg font-bold">0%</div>
            </div>
            <div class="p-3 rounded-lg bg-sky-50">
              <div class="text-xs text-slate-600">Unique Crops</div>
              <div id="uniqueCrops" class="text-lg font-bold">0</div>
            </div>
          </div>
        </div>

        <!-- Market Prices Widget -->
        <div class="dashboard-card">
          <div class="flex items-center justify-between mb-4">
            <h4 class="font-medium">Market Prices</h4>
            <div class="text-xs text-slate-500">Local mandi</div>
          </div>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <div class="text-sm">Tomato</div>
              <div class="font-semibold">₹1,800/q</div>
              <div class="text-xs text-emerald-600">+12%</div>
            </div>
            <div class="flex justify-between items-center">
              <div class="text-sm">Potato</div>
              <div class="font-semibold">₹1,200/q</div>
              <div class="text-xs text-rose-600">-5%</div>
            </div>
            <div class="flex justify-between items-center">
              <div class="text-sm">Rice</div>
              <div class="font-semibold">₹2,500/q</div>
              <div class="text-xs text-emerald-600">+3%</div>
            </div>
          </div>
          <div class="market-price-trend mt-3">
            <div class="market-price-line"></div>
          </div>
          <div class="text-xs text-slate-500 mt-2">Last updated: Today 9:30 AM</div>
        </div>

     

    <!-- Floating Chat Assistant -->
    <div class="chat-container hidden" id="chatbotContainer">
      <div class="chat-header">
        <div>
          <div class="font-semibold">AI Kisan Saathi</div>
          <div class="text-xs opacity-80">Ask me about farming</div>
        </div>
        <div class="flex gap-2">
          <button class="lang-btn active" data-lang="en">EN</button>
          <button class="lang-btn" data-lang="hi">HI</button>
          <button class="lang-btn" data-lang="ta">TA</button>
          <button class="lang-btn" data-lang="te">TE</button>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="message bot-message">
          Hello! I'm your AI farming assistant. How can I help you today?
        </div>
        <div class="message bot-message">
          नमस्ते! मैं आपकी AI कृषि सहायक हूं। आज मैं आपकी कैसे मदद कर सकती हूं?
        </div>
      </div>
      <div class="chat-input-container">
        <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
        <button class="voice-btn" id="voiceBtn">
          <i class="fas fa-microphone"></i>
        </button>
        <button class="btn-primary" id="sendBtn">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>

    <div class="chat-toggle" id="chatToggle">
      <i class="fas fa-comments"></i>
    </div>

    <footer class="text-center mt-8 text-xs text-slate-500 py-4 border-t">
      FarmGuru AI • Hackathon Prototype • Built for demonstration purposes
    </footer>
  </div>

  <script>
  (function(){
    // === Mock DB & samples ===
    const DISEASE_DB = [
      {
        id: "tomato_leaf_curl",
        crop: "Tomato",
        name_en: "Tomato Leaf Curl Virus",
        name_hi: "टमाटर लीफ कर्ल वायरस",
        name_ta: "தக்காளி இலை சுருள் வைரஸ்",
        name_te: "టమాటా ఆకు కర్ల్ వైరస్",
        symptoms_en: ["Upward curling of leaves", "Stunted growth", "Yellowing between veins"],
        symptoms_hi: ["पत्तों का ऊपर की ओर मुड़ना", "विकास रुकना", "नसों के बीच पीलापन"],
        symptoms_ta: ["இலைகள் மேல்நோக்கி சுருள்", "வளர்ச்சி குன்றியது", "நரம்புகளுக்கு இடையே மஞ்சள் நிறமாதல்"],
        symptoms_te: ["ఆకులు పైకి వంకరతో", "పెరుగుదల నిలిచిపోవడం", "సిరల మధ్య పసుపు రంగు"],
        treatment_en: ["Spray Neem oil 3ml/L water (repeat after 7 days)", "Remove heavily infected plants", "Use yellow sticky traps to control whitefly vectors"],
        treatment_hi: ["नीम तेल 3ml/लीटर पानी में स्प्रे करें (7 दिन बाद दोहराएँ)", "बहुत संक्रमित पौधों को हटा दें", "व्हाइटफ्लाई नियंत्रण के लिए पीले स्टिकी ट्रैप लगाएँ"],
        treatment_ta: ["வேப்ப எண்ணெய் 3ml/லி தண்ணீரில் தெளிக்கவும் (7 நாட்களுக்குப் பிறகு மீண்டும்)", "கடுமையாக பாதிக்கப்பட்ட செடிகளை அகற்றவும்", "வெள்ளை ஈ வெக்டர்களை கட்டுப்படுத்த மஞ்சள் ஒட்டும் பொறிகளைப் பயன்படுத்தவும்"],
        treatment_te: ["నీమ్ ఆయిల్ 3ml/లీటరు నీటిలో స్ప్రే చేయండి (7 రోజుల తర్వాత పునరావృతం చేయండి)", "అత్యంత సోకిన మొక్కలను తీసివేయండి", "వైట్ ఫ్లై వెక్టర్స్ నియంత్రణకు పసుపు స్టికీ ట్రాప్లను ఉపయోగించండి"],
        severity: 65 // 0-100 scale
      },
      {
        id: "potato_early_blight",
        crop: "Potato",
        name_en: "Early Blight",
        name_hi: "अर्ली ब्लाइट",
        name_ta: "ஆர்லி பிளைட்",
        name_te: "అర్లీ బ్లైట్",
        symptoms_en: ["Dark concentric rings on leaves", "Brown lesions"],
        symptoms_hi: ["पत्तों पर गोल-गोल काले छल्ले", "भूरे धब्बे"],
        symptoms_ta: ["இலைகளில் கருமையான குவிந்த வளையங்கள்", "பழுப்பு காயங்கள்"],
        symptoms_te: ["ఆకులపై నల్లని కేంద్రిక వలయాలు", "బ్రౌన్ లెషన్స్"],
        treatment_en: ["Spray Mancozeb 2g/L or Chlorothalonil as per label", "Remove debris; follow 3-year crop rotation"],
        treatment_hi: ["मैनकोजेब 2g/लीटर या क्लोरोथालोनिल लेबल अनुसार स्प्रे करें", "कचरा हटाएँ; 3 साल की फसल चक्र अपनाएँ"],
        treatment_ta: ["லேபலின் படி மான்கோசெப் 2g/லி அல்லது குளோரோத்தலோனில் தெளிக்கவும்", "குப்பைகளை அகற்றவும்; 3-வருட பயிர் சுழற்சியைப் பின்பற்றவும்"],
        treatment_te: ["లేబల్ ప్రకారం మ్యాన్కోజెబ్ 2g/లీటరు లేదా క్లోరోతలోనిల్ స్ప్రే చేయండి", "చెత్తను తీసివేయండి; 3-సంవత్సరాల పంట భ్రమణాన్ని అనుసరించండి"],
        severity: 45
      },
      {
        id: "rice_blast",
        crop: "Rice",
        name_en: "Rice Blast",
        name_hi: "ब्लास्ट रोग",
        name_ta: "ரைஸ் பிளாஸ்ட்",
        name_te: "రైస్ బ్లాస్ట్",
        symptoms_en: ["Spindle-shaped lesions on leaves", "Grey centers with brown borders"],
        symptoms_hi: ["पत्तों पर भाले जैसे धब्बे", "ग्रे केंद्र और भूरे किनारे"],
        symptoms_ta: ["இலைகளில் நூற்றிழை வடிவ காயங்கள்", "பழுப்பு எல்லைகளுடன் சாம்பல் மையங்கள்"],
        symptoms_te: ["ఆకులపై స్పిండిల్- ఆకారపు ఘాతలు", "బ్రౌన్ సరిహద్దులతో గ్రే సెంటర్లు"],
        treatment_en: ["Maintain field drainage; avoid excess nitrogen", "Spray Tricyclazole 0.6g/L"],
        treatment_hi: ["खेत की निकास व्यवस्था रखें; नाइट्रोजन अधिक न दें", "ट्राइसाइक्लाजोल 0.6g/लीटर स्प्रे करें"],
        treatment_ta: ["வயல் வடிகால் பராமரிக்க; அதிக நைட்ரஜன் தவிர்க்க", "ட்ரைசைக்ளசோல் 0.6g/லி தெளிக்கவும்"],
        treatment_te: ["ఫీల్డ్ డ్రైనేజీని నిర్వహించండి; అధిక నైట్రోజన్ నివారించండి", "ట్రైసైక్లాజోల్ 0.6g/లీటరు స్ప్రే చేయండి"],
        severity: 75
      }
    ];

    const SAMPLE_IMAGES = {
      tomato_leaf_curl: "https://images.unsplash.com/photo-1566843971944-0296e7c58b05?auto=format&fit=crop&w=600&q=80",
      potato_early_blight: "https://images.unsplash.com/photo-1602540663439-5b9b2a3e6468?auto=format&fit=crop&w=600&q=80",
      rice_blast: "https://images.unsplash.com/photo-1501004318641-b39e6451bec6?auto=format&fit=crop&w=600&q=80"
    };

    // Chatbot knowledge base
    const CHATBOT_KB = {
      en: {
        greeting: [
          "Hello! I'm your AI farming assistant. How can I help you today?",
          "Hi there! I'm here to help with your farming questions. What would you like to know?",
          "Namaste! I'm your digital kisan mitra. How can I assist you today?"
        ],
        farewell: [
          "Goodbye! Feel free to come back with more questions.",
          "See you later! Happy farming!",
          "Take care! May your fields be prosperous."
        ],
        thanks: [
          "You're welcome! Happy to help a fellow farmer.",
          "My pleasure! Don't hesitate to ask if you need more help.",
          "Anytime! That's what I'm here for."
        ],
        questions: {
          "organic pest control": "For organic pest control, try neem oil spray (5ml per liter), garlic-chili spray, or introducing beneficial insects like ladybugs. Crop rotation also helps prevent pest buildup.",
          "best time to water plants": "The best time to water plants is early morning before 10am. This allows water to reach roots before evaporating and prevents fungal diseases that can occur with evening watering.",
          "tomato fertilizer schedule": "Tomatoes need fertilizer at planting time (balanced 10-10-10), when first fruits appear (high phosphorus), and every 4-6 weeks during growing season with balanced fertilizer.",
          "how to improve soil health": "Improve soil health by adding organic matter like compost, practicing crop rotation, using cover crops, reducing tillage, and maintaining proper pH levels.",
          "common rice diseases": "Common rice diseases include blast (leaf and neck), bacterial leaf blight, sheath blight, brown spot, and tungro virus. Using resistant varieties and proper water management can help prevent these."
        },
        fallback: [
          "I'm not sure about that. Could you try asking in a different way?",
          "That's beyond my knowledge currently. Try asking about crop diseases, pest control, or farming practices.",
          "I'm still learning about that aspect of farming. Please ask me about common agricultural topics."
        ]
      },
      hi: {
        greeting: [
          "नमस्ते! मैं आपकी AI कृषि सहायक हूं। आज मैं आपकी कैसे मदद कर सकती हूं?",
          "हैलो! मैं आपके कृषि संबंधी सवालों में मदद के लिए यहां हूं। आप क्या जानना चाहेंगे?",
          "प्रणाम! मैं आपका डिजिटल किसान मित्र हूं। आज मैं आपकी किस तरह सहायता कर सकता हूं?"
        ],
        farewell: [
          "अलविदा! जब भी更多的 सवाल हों, पूछने में संकोच न करें।",
          "फिर मिलेंगे! खुशहाल खेती करें!",
          "ध्यान रखना! आपके खेत समृद्ध हों।"
        ],
        thanks: [
          "आपका स्वागत है! एक साथी किसान की मदद करके खुशी हुई।",
          "मेरी खुशी! यदि आपको अधिक帮助 चाहिए तो hesitate न करें।",
          "कभी भी! मैं इसी के लिए यहां हूं।"
        ],
        questions: {
          "जैविक कीट नियंत्रण": "जैविक कीट नियंत्रण के लिए, नीम का तेल स्प्रे (5ml प्रति लीटर), लहसुन-मिर्च का स्प्रे, या लेडीबग जैसे लाभकारी कीड़ों का उपयोग करें। फसल चक्रण भी कीटों के जमाव को रोकने में मदद करता है।",
          "पौधों को पानी देने का सबसे अच्छा समय": "पौधों को पानी देने का सबसे अच्छा समय सुबह 10 बजे से पहले का है। इससे पानी वाष्पित होने से पहले जड़ों तक पहुंच जाता है और शाम को पानी देने से होने वाली फंगल बीमारियों को रोकता है।",
          "टमाटर की उर्वरक अनुसूची": "टमाटर को रोपण के समय (संतुलित 10-10-10), जब पहले फल दिखाई देते हैं (उच्च फास्फोरस), और बढ़ते मौसम के दौरान हर 4-6 सप्ताह में संतुलित उर्वरक की आवश्यकता होती है।",
          "मृदा स्वास्थ्य कैसे सुधारें": "मृदा स्वास्थ्य में सुधार के लिए कम्पोस्ट जैसे कार्बनिक पदार्थ डालें, फसल चक्रण का अभ्यास करें, कवर फसलों का उपयोग करें, जुताई कम करें और उचित pH स्तर बनाए रखें।",
          "चावल की सामान्य बीमारियां": "चावल की सामान्य बीमारियों में ब्लास्ट (पत्ती और गर्दन), जीवाणुजनित पत्ती झुलसा, शीथ ब्लाइट, ब्राउन स्पॉट और टंगरो वायरस शामिल हैं। प्रतिरोधी किस्मों का उपयोग और उचित जल प्रबंधन इन्हें रोकने में मदद कर सकता है।"
        },
        fallback: [
          "मुझे इस बारे में यकीन नहीं है। क्या आप इसे अलग तरीके से पूछने की कोशिश कर सकते हैं?",
          "यह currently मेरी जानकारी से beyond है। फसल रोगों, कीट नियंत्रण या कृषि पद्धतियों के बारे में पूछने का प्रयास करें।",
          "मैं अभी भी कृषि के उस पहलू के बारे में सीख रहा हूं। कृपया मुझे सामान्य कृषि विषयों के बारे में पूछें।"
        ]
      },
      ta: {
        greeting: [
          "வணக்கம்! நான் உங்கள் AI விவசாய உதவியாளர். இன்று நான் உங்களுக்கு எவ்வாறு உதவலாம்?",
          "வணக்கம்! உங்கள் விவசாய கேள்விகளுக்கு உதவ நான் இங்கே இருக்கிறேன். நீங்கள் என்ன தெரிந்து கொள்ள விரும்புகிறீர்கள்?",
          "நமஸ்காரம்! நான் உங்கள் டிஜிட்டல் விவசாய நண்பன். இன்று நான் உங்களுக்கு எவ்வாறு உதவ முடியும்?"
        ],
        farewell: [
          "சென்று வருகிறேன்! மேலும் கேள்விகள் இருந்தால் தயங்காமல் கேளுங்கள்.",
          "பிறகு சந்திப்போம்! மகிழ்ச்சியான விவசாயம்!",
          "கவனித்துக் கொள்ளுங்கள்! உங்கள் வயல்கள் வளமுடன் விளங்கட்டும்."
        ],
        thanks: [
          "தயை செய்து! ஒரு விவசாயியை உதவுவதில் மகிழ்ச்சி.",
          "எனது மகிழ்ச்சி! உங்களுக்கு மேலும் உதவி தேவைப்பட்டால் தயங்காமல் கேளுங்கள்.",
          "எப்போது வேண்டுமானாலும்! அதற்காகத்தான் நான் இங்கே இருக்கிறேன்."
        ],
        questions: {
          "கரிம பூச்சி கட்டுப்பாடு": "கரிம பூச்சி கட்டுப்பாட்டிற்கு, வேப்ப எண்ணெய் தெளிப்பு (லிட்டருக்கு 5ml), பூண்டு-மிளகாய் தெளிப்பு, அல்லது லேடிபக்குகள் போன்ற பயனுள்ள பூச்சிகளை அறிமுகப்படுத்தவும். பயிர் சுழற்சியும் பூச்சிகளின் குவிப்பை தடுக்க உதவுகிறது.",
          "தாவரங்களுக்கு நீர் ஊட்டுவதற்கான சிறந்த நேரம்": "தாவரங்களுக்கு நீர் ஊட்டுவதற்கான சிறந்த நேரம் காலை 10 மணிக்கு முன்பு. இது நீர் ஆவியாகும் முன் வேர்களை அடைய அனுமதிக்கிறது மற்றும் மாலை நீர்ப்பாசனத்தால் ஏற்படக்கூடிய பூஞ்சை நோய்களை தடுக்கிறது.",
          "தக்காளி உர அட்டவணை": "தக்காளிக்கு நடும் நேரத்தில் (சமச்சீர் 10-10-10), முதல் பழங்கள் தோன்றும் போது (அதிக பாஸ்பரஸ்), மற்றும் வளரும் பருவத்த期间每 4-6 வாரங்களுக்கு சமச்சீர் உரம் தேவைப்படுகிறது.",
          "மண் ஆரோக்கியத்தை எவ்வாறு மேம்படுத்துவது": "கூட்டு போன்ற கரிமப் பொருட்களைச் சேர்ப்பதன் மூலம் மண்ணின் ஆரோக்கியத்தை மேம்படுத்தவும், பயிர் சுழற்சியைப் பயிற்சி செய்யவும், கவர் பயிர்களைப் பயன்படுத்தவும், உழவைக் குறைக்கவும் மற்றும் சரியான pH அளவை பராமரிக்கவும்.",
          "பொது நெல் நோய்கள்": "பொது நெல் நோய்களில் பிளாஸ்ட் (இலை மற்றும் கழுத்து), பாக்டீரியா இலை ப்ளைட், ஷீத் ப்ளைட், பழுப்பு புள்ளி மற்றும் துங்ரோ வைரஸ் ஆகியவை அடங்கும். எதிர்ப்பு வகைகளைப் பயன்படுத்துவதும் மற்றும் சரியான நீர் மேலாண்மையும் இவற்றைத் தடுக்க உதவும்."
        },
        fallback: [
          "அதைப் பற்றி எனக்குத் தெரியாது. வித்தியாசமான வழியில் கேட்க முயற்சிக்கலாமா?",
          "அது தற்போது எனது அறிவைத் தாண்டியது. பயிர் நோய்கள், பூச்சி கட்டுப்பாடு அல்லது விவசாய நடைமுறைகள் பற்றி கேட்க முயற்சிக்கவும்.",
          "நான் இன்னும் விவசாயத்தின் அந்த அம்சத்தைப் பற்றி கற்றுக் கொண்டிருக்கிறேன். தயவு செய்து பொதுவான விவசாய தலைப்புகளைப் பற்றி கேளுங்கள்."
        ]
      },
      te: {
        greeting: [
          "నమస్కారం! నేను మీ AI వ్యవసాయ సహాయకుడిని. ఈరోజు నేను మీకు ఎలా సహాయపడగలను?",
          "హలో! మీ వ్యవసాయ ప్రశ్నలకు సహాయం చేయడానికి నేను ఇక్కడ ఉన్నాను. మీరు ఏమి తెలుసుకోవాలనుకుంటున్నారు?",
          "నమస్తే! నేను మీ డిజిటల్ రైతు మిత్రుడిని. ఈరోజు నేను మీకు ఎలా సహాయం చేయగలను?"
        ],
        farewell: [
          "వీడ్కోలు! మరిన్ని ప్రశ్నలు ఉంటే తిరిగి వచ్చేందుకు సంకోచించకండి.",
          "తర్వాత కలుద్దాం! సంతోషకరమైన వ్యవసాయం!",
          "జాగ్రత్తగా ఉండండి! మీ పొలాలు సమృద్ధిగా ఉండుగాక."
        ],
        thanks: [
          "మీరు స్వాగతం! ఒక తోటి రైతుకు సహాయం చేయడం సంతోషంగా ఉంది.",
          "నా సంతోషం! మీకు మరింత సహాయం కావాలంటే సంకోచించకండి.",
          "ఎప్పుడు అయినా! దాని కోసమే నేను ఇక్కడ ఉన్నాను."
        ],
        questions: {
          "సేంద్రీయ కీటక నియంత్రణ": "సేంద్రీయ కీటక నియంత్రణ కోసం, నీమ్ ఆయిల్ స్ప్రే (లీటరుకు 5ml), వెల్లుల్లి-మిరప స్ప్రే, లేదా లేడీబగ్స్ వంటి ప్రయోజనకరమైన కీటకాలను పరిచయం చేయండి. పంట భ్రమణం కీటకాల నిర్మాణాన్ని నిరోధించడంలో కూడా సహాయపడుతుంది.",
          "మొక్కలకు నీరు పోయడానికి ఉత్తమ సమయం": "మొక్కలకు నీరు పోయడానికి ఉత్తమ సమయం ఉదయం 10 గంటలకు ముందు. ఇది నీరు బాష్పీభవించే ముందు వేర్లను చేరుకోవడానికి అనుమతిస్తుంది మరియు సాయంత్రం నీరు పోయడం వలన కలిగే ఫంగల్ రోగాలను నిరోధిస్తుంది.",
          "టమాటా ఎరువు షెడ్యూల్": "టమాటాకు నాటే సమయంలో (సమతుల్య 10-10-10), మొదటి పండ్లు కనిపించినప్పుడు (ఎక్కువ భాస్వరం), మరియు పెరుగుతున్న సీజన్期间每 4-6 వారాలకు సమతుల్య ఎరువు అవసరం.",
          "నేల ఆరోగ్యాన్ని ఎలా మెరుగుపరచాలి": "కంపోస్ట్ వంటి సేంద్రీయ పదార్థాలను జోడించడం ద్వారా నేల ఆరోగ్యాన్ని మెరుగుపరచండి, పంట భ్రమణం అభ్యసించండి, కవర్ పంటలను ఉపయోగించండి, వ్యవసాయం తగ్గించండి మరియు సరైన pH స్థాయిలను నిర్వహించండి.",
          "సాధారణ బియ్యం రోగాలు": "సాధారణ బియ్యం రోగాలలో బ్లాస్ట్ (ఆకు మరియు మెడ), బాక్టీరియా ఆకు బ్లైట్, షీత్ బ్లైట్, బ్రౌన్ స్పాట్ మరియు టుంగ్రో వైరస్ ఉన్నాయి. నిరోధక రకాలను ఉపయోగించడం మరియు సరైన నీటి నిర్వహణ ఇవి నివారించడంలో సహాయపడతాయి."
        },
        fallback: [
          "దాని గురించి నాకు ఖచ్చితంగా తెలియదు. మీరు దీన్ని వేరే విధంగా అడగడానికి ప్రయత్నించగలరా?",
          "ఇది ప్రస్తుతం నా జ్ఞానానికి మించినది. పంట రోగాలు, కీటక నియంత్రణ లేదా వ్యవసాయ పద్ధతుల గురించి అడగడానికి ప్రయత్నించండి.",
          "నేను ఇంకా వ్యవసాయం యొక్క ఆ అంశం గురించి నేర్చుకుంటున్నాను. దయచేసి సాధారణ వ్యవసాయ విషయాల గురించి అడగండి."
        ]
      }
    };

    // === DOM refs ===
    const fileInput = document.getElementById("fileInput");
    const btnUpload = document.getElementById("btnUpload");
    const btnSample = document.getElementById("btnSample");
    const previewWrap = document.getElementById("previewWrap");
    const previewPlaceholder = document.getElementById("previewPlaceholder");

    const btnDetect = document.getElementById("btnDetect");
    const cropInput = document.getElementById("cropInput");
    const confRange = document.getElementById("confRange");
    const confLabel = document.getElementById("confLabel");
    const progressWrap = document.getElementById("progressWrap");
    const progressBar = document.getElementById("progressBar");
    const progressPercent = document.getElementById("progressPercent");
    const progressText = document.getElementById("progressText");

    const resultCard = document.getElementById("resultCard");
    const detectedName = document.getElementById("detectedName");
    const tagCrop = document.getElementById("tagCrop");
    const tagConf = document.getElementById("tagConf");
    const advList = document.getElementById("advList");
    const symList = document.getElementById("symList");
    const storesList = document.getElementById("storesList");
    const mapEl = document.getElementById("map");
    const btnSpeak = document.getElementById("btnSpeak");
    const langSelect = document.getElementById("langSelect");
    const onlineDot = document.getElementById("onlineDot");
    const onlineText = document.getElementById("onlineText");

    const statDetections = document.getElementById("statDetections");
    const statFlags = document.getElementById("statFlags");
    const historyList = document.getElementById("historyList");
    const btnExportCSV = document.getElementById("btnExportCSV");
    const btnClearHistory = document.getElementById("btnClearHistory");

    const diseaseChartCtx = document.getElementById("diseaseChart");
    const avgConf = document.getElementById("avgConf");
    const uniqueCrops = document.getElementById("uniqueCrops");

    const notesEl = document.getElementById("notes");
    const btnPdf = document.getElementById("btnPdf");
    const btnFlag = document.getElementById("btnFlag");
    const btnShare = document.getElementById("shareBtn");

    const btnDark = document.getElementById("darkToggle");
    const btnSaveImage = document.getElementById("btnSaveImage");
    const btnAnalyze = document.getElementById("btnAnalyze");
    const btnApiSim = document.getElementById("btnApiSim");
    const btnShareAdvisory = document.getElementById("btnShareAdvisory");

    // NEW: References for added features
    const severityFill = document.getElementById("severityFill");
    const severityValue = document.getElementById("severityValue");
    const fieldArea = document.getElementById("fieldArea");
    const recommendedDosage = document.getElementById("recommendedDosage");
    const pesticideResult = document.getElementById("pesticideResult");
    const btnCalculatePesticide = document.getElementById("btnCalculatePesticide");
    const cropCalendar = document.getElementById("cropCalendar");
    const currentMonth = document.getElementById("currentMonth");
    const chatbotContainer = document.getElementById("chatbotContainer");
    const chatToggle = document.getElementById("chatToggle");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const voiceBtn = document.getElementById("voiceBtn");
    const sendBtn = document.getElementById("sendBtn");
    const langButtons = document.querySelectorAll(".lang-btn");
    const weatherContainer = document.getElementById("weatherContainer");
    const currentTemp = document.getElementById("currentTemp");
    const weatherCondition = document.getElementById("weatherCondition");
    const weatherHumidity = document.getElementById("weatherHumidity");
    const weatherRain = document.getElementById("weatherRain");
    const weatherAdvice = document.getElementById("weatherAdvice");
    const notification = document.getElementById("notification");
    const notificationIcon = document.getElementById("notificationIcon");
    const notificationTitle = document.getElementById("notificationTitle");
    const notificationMessage = document.getElementById("notificationMessage");

    // state
    let currentImage = null;
    let currentResult = null;
    let session = { detections: [], flags: 0 };
    let leafletMap = null;
    let diseaseChart = null;
    let chatLang = "en";
    let isListening = false;
    let recognition = null;

    // Initialize the application
    function init() {
      // Set up event listeners
      setupEventListeners();
      
      // Initialize UI components
      updateOnline();
      confLabel.textContent = confRange.value + "%";
      confRange.addEventListener("input", () => confLabel.textContent = confRange.value + "%");
      
      // Load session data
      loadSession();
      
      // Initialize analytics
      updateAnalytics();
      
      // Generate calendar
      generateCalendar();
      
      // Update weather
      updateWeather();
      
      // Initialize chatbot
      initChatbot();
      
      // Pre-seed a sample detection for demo purposes
      if (!session.detections.length) {
        const sample = DISEASE_DB[0];
        session.detections.push({ 
          id: sample.id, 
          crop: sample.crop, 
          conf: 82, 
          time: new Date().toISOString() 
        });
        saveSession(); 
        renderHistory(); 
        updateStats(); 
        updateAnalytics();
      }
      
      // Show welcome notification
      showNotification("Welcome to FarmGuru AI", "Your intelligent crop advisory system is ready!", "success");
    }

    // Set up all event listeners
    function setupEventListeners() {
      // File upload
      btnUpload.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", handleFileUpload);
      
      // Drag and drop for image
      previewWrap.addEventListener("dragover", (e) => {
        e.preventDefault();
        previewWrap.classList.add("border-emerald-500", "bg-green-50");
      });
      
      previewWrap.addEventListener("dragleave", () => {
        previewWrap.classList.remove("border-emerald-500", "bg-green-50");
      });
      
      previewWrap.addEventListener("drop", (e) => {
        e.preventDefault();
        previewWrap.classList.remove("border-emerald-500", "bg-green-50");
        
        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
          fileInput.files = e.dataTransfer.files;
          handleFileUpload({ target: fileInput });
        }
      });
      
      // Click to open file dialog
      previewWrap.addEventListener("click", () => fileInput.click());
      
      // Sample image
      btnSample.addEventListener("click", useSampleImage);
      
      // Detection
      btnDetect.addEventListener("click", detectDiseases);
      
      // Language change
      langSelect.addEventListener("change", handleLanguageChange);
      
      // Tabs
      document.querySelectorAll(".tab-btn").forEach(b => {
        b.addEventListener("click", () => {
          document.querySelectorAll(".tab-btn").forEach(x => x.classList.remove("tab-active"));
          b.classList.add("tab-active");
          document.querySelectorAll(".tab-pane").forEach(p => p.classList.add("hidden"));
          const id = b.dataset.tab;
          document.getElementById(id).classList.remove("hidden");
        });
      });
      
      // Speak advisory
      btnSpeak.addEventListener("click", speakAdvisory);
      
      // Export data
      btnExportCSV.addEventListener("click", exportCSV);
      btnClearHistory.addEventListener("click", clearHistory);
      
      // PDF export
      btnPdf.addEventListener("click", generatePDF);
      
      // Flag detection
      btnFlag.addEventListener("click", flagDetection);
      
      // Share
      btnShare.addEventListener("click", shareApp);
      
          // ... (previous JavaScript code continues)

    // Advanced features
    btnDark.addEventListener("change", toggleDarkMode);
    btnSaveImage.addEventListener("click", saveImage);
    btnAnalyze.addEventListener("click", generateReport);
    btnApiSim.addEventListener("click", simulateAPI);
    btnShareAdvisory.addEventListener("click", shareAdvisory);
    
    // Pesticide calculator
    btnCalculatePesticide.addEventListener("click", calculatePesticide);
    fieldArea.addEventListener("input", calculatePesticide);
    
    // Chatbot functionality
    chatToggle.addEventListener("click", toggleChatbot);
    sendBtn.addEventListener("click", sendChatMessage);
    chatInput.addEventListener("keypress", (e) => {
      if (e.key === 'Enter') sendChatMessage();
    });
    
    // Voice recognition
    voiceBtn.addEventListener("click", toggleVoiceRecognition);
    
    // Language buttons in chatbot
    langButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        langButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        chatLang = btn.dataset.lang;
      });
    });
  }

  // Handle file upload
  function handleFileUpload(e) {
    const file = e.target.files[0];
    if (!file || !file.type.match('image.*')) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      currentImage = e.target.result;
      previewPlaceholder.classList.add("hidden");
      previewWrap.innerHTML = `<img src="${currentImage}" alt="Uploaded crop image">`;
    };
    reader.readAsDataURL(file);
  }

  // Use sample image
  function useSampleImage() {
    const sampleKeys = Object.keys(SAMPLE_IMAGES);
    const randomSample = sampleKeys[Math.floor(Math.random() * sampleKeys.length)];
    
    currentImage = SAMPLE_IMAGES[randomSample];
    previewPlaceholder.classList.add("hidden");
    previewWrap.innerHTML = `<img src="${currentImage}" alt="Sample crop image">`;
    
    // Auto-select the matching crop type
    const disease = DISEASE_DB.find(d => d.id === randomSample);
    if (disease) {
      cropInput.value = disease.crop;
    }
    
    showNotification("Sample loaded", "Using a sample image for demonstration", "info");
  }

  // Detect diseases (simulated)
  function detectDiseases() {
    if (!currentImage) {
      showNotification("No image", "Please upload an image first", "error");
      return;
    }
    
    if (!cropInput.value) {
      showNotification("Crop type required", "Please select the crop type", "error");
      return;
    }
    
    // Show progress
    progressWrap.classList.remove("hidden");
    let progress = 0;
    const interval = setInterval(() => {
      progress += 5;
      progressBar.style.width = `${progress}%`;
      progressPercent.textContent = `${progress}%`;
      
      if (progress >= 100) {
        clearInterval(interval);
        processDetectionResult();
      }
    }, 100);
  }

  // Process detection result
  function processDetectionResult() {
    // Simulate AI processing
    const confidence = parseInt(confRange.value);
    const cropType = cropInput.value;
    
    // Find matching diseases for this crop
    const possibleDiseases = DISEASE_DB.filter(d => d.crop === cropType);
    
    if (possibleDiseases.length === 0) {
      showNotification("No diseases found", `No known diseases for ${cropType} in our database`, "warning");
      progressWrap.classList.add("hidden");
      return;
    }
    
    // Randomly select a disease (simulating AI detection)
    const detectedDisease = possibleDiseases[Math.floor(Math.random() * possibleDiseases.length)];
    const detectedConfidence = Math.min(95, confidence + Math.floor(Math.random() * 20) - 10);
    
    // Update session
    session.detections.push({
      id: detectedDisease.id,
      crop: cropType,
      conf: detectedConfidence,
      time: new Date().toISOString()
    });
    saveSession();
    
    // Display results
    displayResults(detectedDisease, detectedConfidence);
    
    // Update UI
    updateStats();
    renderHistory();
    updateAnalytics();
    progressWrap.classList.add("hidden");
    
    showNotification("Detection complete", `${detectedDisease.name_en} detected with ${detectedConfidence}% confidence`, "success");
  }

  // Display results
  function displayResults(disease, confidence) {
    currentResult = disease;
    
    // Update result card
    resultCard.classList.remove("hidden");
    detectedName.textContent = disease[`name_${langSelect.value}`] || disease.name_en;
    tagCrop.textContent = disease.crop;
    tagConf.textContent = `${confidence}%`;
    
    // Update severity indicator
    const severity = disease.severity;
    severityFill.style.width = `${severity}%`;
    severityValue.textContent = getSeverityText(severity);
    severityFill.className = "severity-fill " + getSeverityColor(severity);
    
    // Update advisory
    updateAdvisory(disease);
    
    // Update symptoms
    updateSymptoms(disease);
    
    // Update nearby stores
    updateNearbyStores();
    
    // Update pesticide recommendation
    updatePesticideRecommendation(disease);
  }

  // Get severity text
  function getSeverityText(severity) {
    if (severity < 25) return `Low (${severity}%)`;
    if (severity < 50) return `Moderate (${severity}%)`;
    if (severity < 75) return `High (${severity}%)`;
    return `Critical (${severity}%)`;
  }

  // Get severity color
  function getSeverityColor(severity) {
    if (severity < 25) return "bg-emerald-500";
    if (severity < 50) return "bg-amber-500";
    if (severity < 75) return "bg-orange-500";
    return "bg-rose-500";
  }

  // Update advisory
  function updateAdvisory(disease) {
    const lang = langSelect.value;
    const treatments = disease[`treatment_${lang}`] || disease.treatment_en;
    
    advList.innerHTML = "";
    treatments.forEach(treatment => {
      const li = document.createElement("li");
      li.textContent = treatment;
      li.className = "text-sm";
      advList.appendChild(li);
    });
  }

  // Update symptoms
  function updateSymptoms(disease) {
    const lang = langSelect.value;
    const symptoms = disease[`symptoms_${lang}`] || disease.symptoms_en;
    
    symList.innerHTML = "";
    symptoms.forEach(symptom => {
      const li = document.createElement("li");
      li.textContent = symptom;
      li.className = "text-sm";
      symList.appendChild(li);
    });
  }

  // Update nearby stores
  function updateNearbyStores() {
    // Simulate nearby stores
    const stores = [
      { name: "Kisan Agri Clinic", distance: "2.3 km", rating: "4.2" },
      { name: "Krishi Seva Kendra", distance: "3.1 km", rating: "4.5" },
      { name: "Farm Solutions", distance: "5.7 km", rating: "4.0" }
    ];
    
    storesList.innerHTML = "";
    stores.forEach(store => {
      const div = document.createElement("div");
      div.className = "flex justify-between items-center py-2 border-b";
      div.innerHTML = `
        <div>
          <div class="font-medium">${store.name}</div>
          <div class="text-xs text-slate-500">${store.distance} away</div>
        </div>
        <div class="badge bg-amber-100 text-amber-800">★ ${store.rating}</div>
      `;
      storesList.appendChild(div);
    });
    
    // Initialize map if not already done
    if (!leafletMap) {
      initMap();
    }
  }

  // Initialize map
  function initMap() {
    leafletMap = L.map(mapEl).setView([26.8467, 80.9462], 13); // Default to Lucknow
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(leafletMap);
    
    // Add markers for stores
    L.marker([26.8467, 80.9462]).addTo(leafletMap)
      .bindPopup('Kisan Agri Clinic');
    
    L.marker([26.8567, 80.9562]).addTo(leafletMap)
      .bindPopup('Krishi Seva Kendra');
    
    L.marker([26.8367, 80.9362]).addTo(leafletMap)
      .bindPopup('Farm Solutions');
  }

  // Update pesticide recommendation
  function updatePesticideRecommendation(disease) {
    // Set a recommended dosage based on disease severity
    const dosage = disease.severity > 50 ? "3g/L" : "2g/L";
    recommendedDosage.value = dosage;
    
    // Calculate initial pesticide requirement
    calculatePesticide();
  }

  // Calculate pesticide
  function calculatePesticide() {
    const area = parseFloat(fieldArea.value) || 1;
    const dosageText = recommendedDosage.value;
    const dosageValue = parseFloat(dosageText);
    
    // Calculate required pesticide (assuming 200L water per acre)
    const pesticideNeeded = area * 200 * dosageValue;
    pesticideResult.textContent = `${pesticideNeeded}g`;
  }

  // Speak advisory
  function speakAdvisory() {
    if (!currentResult) return;
    
    const lang = langSelect.value;
    const diseaseName = currentResult[`name_${lang}`] || currentResult.name_en;
    const treatments = currentResult[`treatment_${lang}`] || currentResult.treatment_en;
    
    const speechText = `Treatment for ${diseaseName}. ${treatments.join('. ')}`;
    
    if ('speechSynthesis' in window) {
      const speech = new SpeechSynthesisUtterance(speechText);
      speech.lang = getSpeechLang(lang);
      window.speechSynthesis.speak(speech);
    } else {
      showNotification("Voice not supported", "Your browser doesn't support text-to-speech", "warning");
    }
  }

  // Get speech language code
  function getSpeechLang(lang) {
    const langMap = {
      'en': 'en-IN',
      'hi': 'hi-IN',
      'ta': 'ta-IN',
      'te': 'te-IN'
    };
    return langMap[lang] || 'en-IN';
  }

  // Handle language change
  function handleLanguageChange() {
    const lang = langSelect.value;
    
    // Update UI texts based on language
    updateUITexts(lang);
    
    // Update results if any
    if (currentResult) {
      detectedName.textContent = currentResult[`name_${lang}`] || currentResult.name_en;
      updateAdvisory(currentResult);
      updateSymptoms(currentResult);
    }
  }

  // Update UI texts based on language
  function updateUITexts(lang) {
    // This would be more comprehensive in a real application
    const translations = {
      en: {
        leftTitle: "Crop Health Analysis",
        consentLabel: "Allow anonymous learning",
        resultsHeading: "Result & Advisory",
        resultSub: "Upload & detect to see result"
      },
      hi: {
        leftTitle: "फसल स्वास्थ्य विश्लेषण",
        consentLabel: "अनामिक सीखने की अनुमति दें",
        resultsHeading: "परिणाम और सलाह",
        resultSub: "परिणाम देखने के लिए अपलोड और पहचान करें"
      },
      ta: {
        leftTitle: "பயிர் சுகாதார பகுப்பாய்வு",
        consentLabel: "அநாமதேய கற்றலை அனுமதிக்கவும்",
        resultsHeading: "முடிவு மற்றும் ஆலோசனை",
        resultSub: "முடிவைக் காண பதிவேற்றம் மற்றும் கண்டறிதல்"
      },
      te: {
        leftTitle: "పంట ఆరోగ్య విశ్లేషణ",
        consentLabel: "అజ్ఞాత అభ్యాసాన్ని అనుమతించండి",
        resultsHeading: "ఫలితం మరియు సలహా",
        resultSub: "ఫలితం చూడటానికి అప్లోడ్ మరియు గుర్తించండి"
      }
    };
    
    const t = translations[lang] || translations.en;
    
    // Update UI elements
    document.getElementById("leftTitle").textContent = t.leftTitle;
    document.getElementById("consentLabel").textContent = t.consentLabel;
    document.getElementById("resultsHeading").textContent = t.resultsHeading;
    document.getElementById("resultSub").textContent = t.resultSub;
  }

  // Update online status
  function updateOnline() {
    const isOnline = navigator.onLine;
    onlineDot.className = `h-3 w-3 rounded-full block ${isOnline ? 'bg-emerald-500' : 'bg-slate-400'}`;
    onlineText.textContent = isOnline ? 'Online' : 'Offline';
  }

  // Save session to localStorage
  function saveSession() {
    localStorage.setItem('farmguru_session', JSON.stringify(session));
  }

  // Load session from localStorage
  function loadSession() {
    const saved = localStorage.getItem('farmguru_session');
    if (saved) {
      session = JSON.parse(saved);
      updateStats();
      renderHistory();
      updateAnalytics();
    }
  }

  // Update statistics
  function updateStats() {
    statDetections.textContent = session.detections.length;
    statFlags.textContent = session.flags;
  }

  // Render history
  function renderHistory() {
    historyList.innerHTML = "";
    
    if (session.detections.length === 0) {
      historyList.innerHTML = '<div class="text-center text-slate-500 py-4">No detection history</div>';
      return;
    }
    
    // Show last 5 detections
    const recent = session.detections.slice(-5).reverse();
    
    recent.forEach(detection => {
      const disease = DISEASE_DB.find(d => d.id === detection.id);
      if (!disease) return;
      
      const time = new Date(detection.time).toLocaleTimeString();
      
      const div = document.createElement("div");
      div.className = "flex justify-between items-center py-2 border-b";
      div.innerHTML = `
        <div>
          <div class="font-medium">${disease.crop}</div>
          <div class="text-xs text-slate-500">${disease.name_en}</div>
        </div>
        <div class="text-right">
          <div class="text-sm">${detection.conf}%</div>
          <div class="text-xs text-slate-500">${time}</div>
        </div>
      `;
      historyList.appendChild(div);
    });
  }

  // Update analytics
  function updateAnalytics() {
    if (session.detections.length === 0) {
      avgConf.textContent = "0%";
      uniqueCrops.textContent = "0";
      return;
    }
    
    // Calculate average confidence
    const totalConf = session.detections.reduce((sum, d) => sum + d.conf, 0);
    const avg = Math.round(totalConf / session.detections.length);
    avgConf.textContent = `${avg}%`;
    
    // Count unique crops
    const unique = new Set(session.detections.map(d => d.crop));
    uniqueCrops.textContent = unique.size;
    
    // Update chart
    updateDiseaseChart();
  }

  // Update disease chart
 function updateDiseaseChart() {
    // Count diseases by type
    const diseaseCount = {};
    session.detections.forEach(d => {
      diseaseCount[d.id] = (diseaseCount[d.id] || 0) + 1;
    });
    
    const diseaseNames = [];
    const detectionCounts = [];
    const backgroundColors = [
      '#10B981', '#F59E0B', '#EF4444', '#3B82F6', '#8B5CF6', 
      '#EC4899', '#6366F1', '#14B8A6', '#F97316', '#84CC16'
    ];
    
    Object.keys(diseaseCount).forEach((id, index) => {
      const disease = DISEASE_DB.find(d => d.id === id);
      if (disease) {
        diseaseNames.push(disease.name_en);
        detectionCounts.push(diseaseCount[id]);
      }
    });
    
    // If no data, show a placeholder message
    if (detectionCounts.length === 0) {
      diseaseNames.push("No Data");
      detectionCounts.push(1);
      backgroundColors[0] = '#E5E7EB';
    }
    
    // Destroy previous chart if exists
    if (diseaseChart) {
      diseaseChart.destroy();
    }
    
    // Create new chart with proper configuration
    diseaseChart = new Chart(diseaseChartCtx, {
      type: 'doughnut',
      data: {
        labels: diseaseNames,
        datasets: [{
          data: detectionCounts,
          backgroundColor: backgroundColors,
          borderWidth: 2,
          borderColor: '#FFFFFF'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '60%',
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              boxWidth: 12,
              font: {
                size: 10
              },
              padding: 15
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = Math.round((value / total) * 100);
                return `${label}: ${value} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  }

  // Export CSV
  function exportCSV() {
    if (session.detections.length === 0) {
      showNotification("No data", "There's no data to export", "warning");
      return;
    }
    
    let csv = "Crop,Disease,Confidence,Time\n";
    
    session.detections.forEach(detection => {
      const disease = DISEASE_DB.find(d => d.id === detection.id);
      const diseaseName = disease ? disease.name_en : "Unknown";
      const time = new Date(detection.time).toLocaleString();
      
      csv += `"${detection.crop}","${diseaseName}",${detection.conf},"${time}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `farmguru_export_${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    showNotification("Exported", "Detection history exported as CSV", "success");
  }

  // Clear history
  function clearHistory() {
    if (confirm("Are you sure you want to clear all history?")) {
      session.detections = [];
      saveSession();
      updateStats();
      renderHistory();
      updateAnalytics();
      
      showNotification("History cleared", "All detection history has been removed", "info");
    }
  }

  // Generate PDF
  function generatePDF() {
    if (!currentResult) {
      showNotification("No result", "There's no result to export", "warning");
      return;
    }
    
    // In a real app, we would use jsPDF here
    showNotification("PDF export", "PDF report generation would happen here", "info");
  }

  // Flag detection
  function flagDetection() {
    if (!currentResult) return;
    
    session.flags++;
    saveSession();
    updateStats();
    
    showNotification("Flagged", "This detection has been flagged for review", "info");
  }

  // Share app
  function shareApp() {
    if (navigator.share) {
      navigator.share({
        title: 'FarmGuru AI',
        text: 'Check out this AI-powered crop advisory system',
        url: window.location.href
      })
      .catch(err => {
        showNotification("Sharing failed", "Could not share the app", "error");
      });
    } else {
      // Fallback: copy to clipboard
      navigator.clipboard.writeText(window.location.href)
        .then(() => {
          showNotification("Copied", "App link copied to clipboard", "success");
        })
        .catch(err => {
          showNotification("Copy failed", "Could not copy app link", "error");
        });
    }
  }

  // Toggle dark mode
  function toggleDarkMode() {
    document.body.classList.toggle('dark');
  }

  // Save image
  function saveImage() {
    if (!currentImage) {
      showNotification("No image", "There's no image to save", "warning");
      return;
    }
    
    const a = document.createElement('a');
    a.href = currentImage;
    a.download = 'farmguru_crop_image.jpg';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    showNotification("Image saved", "Crop image downloaded", "success");
  }

  // Generate report
  function generateReport() {
    if (session.detections.length === 0) {
      showNotification("No data", "There's no data to analyze", "warning");
      return;
    }
    
    // Simulate report generation
    showNotification("Report generated", "Analytics report would be generated here", "info");
  }

  // Simulate API
  function simulateAPI() {
    showNotification("API simulation", "This would upload data to cloud API", "info");
  }

  // Share advisory
  function shareAdvisory() {
    if (!currentResult) {
      showNotification("No advisory", "There's no advisory to share", "warning");
      return;
    }
    
    const lang = langSelect.value;
    const diseaseName = currentResult[`name_${lang}`] || currentResult.name_en;
    
    const shareText = `FarmGuru AI detected ${diseaseName} in my ${currentResult.crop} crop. Check out FarmGuru AI for smart farming solutions!`;
    
    if (navigator.share) {
      navigator.share({
        title: 'FarmGuru AI Detection',
        text: shareText,
        url: window.location.href
      })
      .catch(err => {
        showNotification("Sharing failed", "Could not share the advisory", "error");
      });
    } else {
      navigator.clipboard.writeText(shareText)
        .then(() => {
          showNotification("Copied", "Advisory text copied to clipboard", "success");
        })
        .catch(err => {
          showNotification("Copy failed", "Could not copy advisory text", "error");
        });
    }
  }

  // Generate calendar
  function generateCalendar() {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();
    
    // Set current month text
    const monthNames = ["January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"];
    currentMonth.textContent = `${monthNames[month]} ${year}`;
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    // Clear previous calendar
    cropCalendar.innerHTML = "";
    
    // Add empty cells for days before first day of month
    for (let i = 0; i < firstDay; i++) {
      const emptyCell = document.createElement("div");
      emptyCell.className = "crop-calendar-day opacity-30";
      cropCalendar.appendChild(emptyCell);
    }
    
    // Add cells for each day of the month
    const today = now.getDate();
    for (let day = 1; day <= daysInMonth; day++) {
      const dayCell = document.createElement("div");
      dayCell.className = "crop-calendar-day";
      if (day === today) dayCell.classList.add("today");
      dayCell.textContent = day;
      
      // Add click event
      dayCell.addEventListener("click", () => {
        document.querySelectorAll(".crop-calendar-day").forEach(d => d.classList.remove("active"));
        dayCell.classList.add("active");
        
        showNotification("Date selected", `You selected ${day} ${monthNames[month]}`, "info");
      });
      
      cropCalendar.appendChild(dayCell);
    }
  }

  // Update weather
  function updateWeather() {
    // Simulate weather data
    const weatherData = {
      temp: 32,
      condition: "Partly Cloudy",
      humidity: 65,
      rain: 10,
      advice: "Good weather for spraying treatments."
    };
    
    currentTemp.textContent = `${weatherData.temp}°C`;
    weatherCondition.textContent = weatherData.condition;
    weatherHumidity.textContent = `${weatherData.humidity}%`;
    weatherRain.textContent = `${weatherData.rain}%`;
    weatherAdvice.textContent = weatherData.advice;
  }

  // Initialize chatbot
  function initChatbot() {
    // Check if browser supports speech recognition
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.continuous = false;
      recognition.interimResults = false;
      
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        chatInput.value = transcript;
      };
      
      recognition.onend = function() {
        isListening = false;
        voiceBtn.classList.remove("listening");
        voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
      };
    } else {
      voiceBtn.style.display = 'none';
    }
  }

  // Toggle chatbot
  function toggleChatbot() {
    chatbotContainer.classList.toggle("hidden");
  }

  // Send chat message
  function sendChatMessage() {
    const message = chatInput.value.trim();
    if (!message) return;
    
    // Add user message
    addChatMessage(message, "user");
    chatInput.value = "";
    
    // Simulate AI response after a delay
    setTimeout(() => {
      const response = generateChatResponse(message);
      addChatMessage(response, "bot");
    }, 1000);
  }

  // Add chat message
  function addChatMessage(text, sender) {
    const messageDiv = document.createElement("div");
    messageDiv.className = `message ${sender}-message`;
    messageDiv.textContent = text;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Generate chat response
  function generateChatResponse(message) {
    const lowerMessage = message.toLowerCase();
    const kb = CHATBOT_KB[chatLang] || CHATBOT_KB.en;
    
    // Check for greetings
    if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || 
        lowerMessage.includes('नमस्ते') || lowerMessage.includes('வணக்கம்') || 
        lowerMessage.includes('నమస్కారం')) {
      return kb.greeting[Math.floor(Math.random() * kb.greeting.length)];
    }
    
    // Check for thanks
    if (lowerMessage.includes('thank') || lowerMessage.includes('धन्यवाद') || 
        lowerMessage.includes('நன்றி') || lowerMessage.includes('ధన్యవాదాలు')) {
      return kb.thanks[Math.floor(Math.random() * kb.thanks.length)];
    }
    
    // Check for farewell
    if (lowerMessage.includes('bye') || lowerMessage.includes('goodbye') || 
        lowerMessage.includes('अलविदा') || lowerMessage.includes('சென்று வருகிறேன்') || 
        lowerMessage.includes('వీడ్కోలు')) {
      return kb.farewell[Math.floor(Math.random() * kb.farewell.length)];
    }
    
    // Check for known questions
    for (const [key, answer] of Object.entries(kb.questions)) {
      if (lowerMessage.includes(key)) {
        return answer;
      }
    }
    
    // Fallback response
    return kb.fallback[Math.floor(Math.random() * kb.fallback.length)];
  }

  // Toggle voice recognition
  function toggleVoiceRecognition() {
    if (!recognition) {
      showNotification("Voice not supported", "Your browser doesn't support voice recognition", "warning");
      return;
    }
    
    if (isListening) {
      recognition.stop();
    } else {
      recognition.start();
      isListening = true;
      voiceBtn.classList.add("listening");
      voiceBtn.innerHTML = '<i class="fas fa-circle"></i>';
    }
  }

  // Show notification
  function showNotification(title, message, type) {
    notificationTitle.textContent = title;
    notificationMessage.textContent = message;
    
    // Set icon and color based on type
    let icon = "fa-info-circle";
    if (type === "success") icon = "fa-check-circle";
    if (type === "error") icon = "fa-exclamation-circle";
    if (type === "warning") icon = "fa-exclamation-triangle";
    
    notificationIcon.className = `fas ${icon}`;
    notification.className = `notification notification-${type}`;
    
    // Show notification
    notification.classList.remove("hidden");
    setTimeout(() => {
      notification.classList.add("show");
    }, 10);
    
    // Hide after 5 seconds
    setTimeout(() => {
      notification.classList.remove("show");
      setTimeout(() => {
        notification.classList.add("hidden");
      }, 300);
    }, 5000);
  }

  // Initialize the app when DOM is loaded
  document.addEventListener('DOMContentLoaded', init);
  
  // Update online status when network changes
  window.addEventListener('online', updateOnline);
  window.addEventListener('offline', updateOnline);
})();
</script>
</body>
</html>




