<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FarmGuru AI — Intelligent Crop Advisory System</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Leaflet (maps) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary: #059669;
      --primary-dark: #047857;
      --secondary: #F59E0B;
      --accent: #10B981;
      --muted: #64748b;
      --danger: #EF4444;
      --warning: #F59E0B;
      --success: #10B981;
    }
    
    body {
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 600;
      border: none;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(5, 150, 105, 0.25);
    }
    
    .btn-outline {
      background: white;
      border: 1px solid #e6e9ef;
      padding: 10px 16px;
      border-radius: 10px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    
    .btn-outline:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .input {
      width: 100%;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #e6e9ed;
      transition: all 0.2s ease;
    }
    
    .input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
    }
    
    .tab-btn {
      padding: 8px 16px;
      border: none;
      background: transparent;
      font-weight: 600;
      color: #334155;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    
    .tab-btn:hover {
      color: var(--primary);
    }
    
    .tab-active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    
    #previewWrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.35s ease;
      border-radius: 12px;
    }
    
    #previewWrap img:hover {
      transform: scale(1.03);
    }
    
    body.dark {
      background: linear-gradient(180deg, #0b0384, #b30376);
      color: #dbeadf;
    }
    
    body.dark .bg-white {
      background: rgba(255, 255, 255, 0.05) !important;
      border: 1px solid rgba(255, 255, 255, 0.1);
    } 
    
    .small-muted {
      font-size: 12px;
      color: var(--muted);
    }
    
    .badge {
      background: #ecfdf5;
      color: #065f46;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 12px;
    }
    
    .severity-indicator {
      height: 8px;
      border-radius: 4px;
      background: #e5e7eb;
      overflow: hidden;
    }
    
    .severity-fill {
      height: 100%;
      transition: width 0.5s ease;
    }
    
    .weather-card {
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      color: white;
      border-radius: 12px;
      padding: 16px;
    }
    
    .pesticide-card {
      border-left: 4px solid var(--accent);
      padding-left: 16px;
    }
    
    .crop-calendar-day {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .crop-calendar-day.active {
      background: var(--accent);
      color: white;
    }
    
    .crop-calendar-day.today {
      border: 2px solid var(--accent);
    }
    
    .market-price-trend {
      height: 40px;
      width: 100%;
      position: relative;
    }
    
    .market-price-line {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent);
    }
    
    /* Chatbot Styles */
    .chat-container {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 380px;
      height: 500px;
      background: white;
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      z-index: 1000;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .chat-header {
      background: var(--primary);
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top-left-radius: 18px;
      border-top-right-radius: 18px;
    }
    
    .chat-messages {
      flex: 1;
      padding: 16px 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #f8fafc;
    }
    
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.4;
      font-size: 14px;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .bot-message {
      background: white;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .user-message {
      background: var(--primary);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      box-shadow: 0 2px 8px rgba(5, 150, 105, 0.2);
    }
    
    .chat-input-container {
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 10px;
      background: #f9fafb;
    }
    
    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      outline: none;
      font-size: 14px;
    }
    
    .chat-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 16px rgba(5, 150, 105, 0.3);
      cursor: pointer;
      z-index: 1001;
      transition: all 0.3s ease;
    }
    
    .chat-toggle:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(5, 150, 105, 0.4);
    }
    
    .voice-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--muted);
      padding: 6px;
      border-radius: 50%;
      transition: all 0.2s ease;
    }
    
    .voice-btn:hover {
      background: #f1f5f9;
      color: var(--primary);
    }
    
    .voice-btn.listening {
      background: #fee2e2;
      color: var(--danger);
      animation: pulse 1.5s infinite;
    }
    
    .lang-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      transition: all 0.2s ease;
    }
    
    .lang-btn.active {
      background: white;
      color: var(--primary);
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    /* Dashboard Cards */
    .dashboard-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }
    
    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    }
    
    /* Progress Animation */
    @keyframes progress {
      0% { background-position: 0 0; }
      100% { background-position: 40px 0; }
    }
    
    .progress-bar {
      height: 8px;
      border-radius: 4px;
      background-color: #e5e7eb;
      overflow: hidden;
    }
    
    .progress-bar-fill {
      height: 100%;
      border-radius: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      background-size: 40px 100%;
      animation: progress 1s linear infinite;
    }
    
    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 10px;
      background: white;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 2000;
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }
    
    .notification-success {
      border-left: 4px solid var(--success);
    }
    
    .notification-error {
      border-left: 4px solid var(--danger);
    }
    
    .notification-warning {
      border-left: 4px solid var(--warning);
    }

    /* New styles for multi-image and enhanced features */
    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
      margin-bottom: 10px;
      max-height: 150px;
      overflow-y: auto;
    }
    
    .image-item {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      height: 80px;
    }
    
    .image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .image-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 2px 4px;
      font-size: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .file-summary {
      text-align: center;
      font-size: 12px;
      color: #666;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #e5e7eb;
    }
    
    .store-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .scheme-item:hover {
      transform: translateX(5px);
      transition: transform 0.2s ease;
    }
    
    .price-item {
      transition: all 0.3s ease;
    }
    
    .price-item:hover {
      background: #f0fdf4;
      padding: 8px;
      border-radius: 8px;
      margin: 0 -8px;
    }
    
    .custom-marker {
      animation: pulse 2s infinite;
    }
    
    /* Responsive */
    @media (max-width: 1024px) {
      .grid-cols-3 {
        grid-template-columns: 1fr 1fr !important;
      }
    }
    
    @media (max-width: 768px) {
      .grid-cols-3 {
        grid-template-columns: 1fr !important;
      }
      
      .chat-container {
        right: 10px;
        bottom: 80px;
        width: calc(100% - 20px);
        height: 65%;
      }
      
      .chat-toggle {
        bottom: 10px;
        right: 10px;
        width: 56px;
        height: 56px;
      }
      
      .image-grid {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      }
    }
  </style>
</head>
<body class="bg-gradient-to-b from-green-50 to-emerald-100 min-h-screen text-slate-800">
  <!-- Notification System -->
  <div id="notification" class="notification hidden">
    <i id="notificationIcon" class="fas fa-info-circle"></i>
    <div>
      <div id="notificationTitle" class="font-semibold"></div>
      <div id="notificationMessage" class="text-sm"></div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto p-6">
    <!-- Header -->
    <header class="flex flex-wrap items-center justify-between gap-4 mb-8">
      <div class="flex items-center gap-4">
        <div class="rounded-2xl bg-emerald-700 p-3 text-white shadow-lg">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M3 21s7-4 10-8 4-8 4-8-6.5 0-11 4S3 21 3 21z" fill="white"></path></svg>
        </div>
        <div>
          <h1 class="text-2xl md:text-3xl font-bold" id="appTitle">FarmGuru AI</h1>
          <p class="small-muted" id="appSubtitle">Intelligent Crop Advisory System · Hackathon Prototype</p>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <a href="Market.html" data-lang-key="contact">MarketPlace</a>
        <div id="onlineBadge" class="flex items-center gap-2 px-3 py-1 rounded-full border bg-white/70 shadow-sm">
              
          <span id="onlineDot" class="h-3 w-3 rounded-full bg-emerald-500 block"></span>
                  
          <span id="onlineText" class="text-sm">Online</span>
        </div>

        <select id="langSelect" class="rounded-lg border px-3 py-1 bg-white">
          <option value="en">English</option>
          <option value="hi">हिंदी</option>
          <option value="ml">മലയാളം</option>
          <option value="te">తెలుగు</option>
          <option value="mr">मराठी</option>
        </select>

        <button id="shareBtn" class="px-4 py-2 rounded-lg bg-emerald-600 text-white shadow flex items-center gap-2">
          <i class="fas fa-share-alt"></i> <span id="shareText">Share</span>
        </button>
      </div>
    </header>

    <!-- Dashboard Stats -->
    <div class="grid grid-cols-4 gap-4 mb-6">
      <div class="dashboard-card flex items-center gap-4">
        <div class="p-3 rounded-xl bg-emerald-100 text-emerald-700">
          <i class="fas fa-leaf text-xl"></i>
        </div>
        <div>
          <div class="text-sm text-slate-500" id="detectionLabel">Detections Today</div>
          <div class="text-2xl font-bold">12</div>
        </div>
      </div>
      
      <div class="dashboard-card flex items-center gap-4">
        <div class="p-3 rounded-xl bg-amber-100 text-amber-700">
          <i class="fas fa-exclamation-triangle text-xl"></i>
        </div>
        <div>
          <div class="text-sm text-slate-500" id="alertsLabel">Disease Alerts</div>
          <div class="text-2xl font-bold">3</div>
        </div>
      </div>
      
      <div class="dashboard-card flex items-center gap-4">
        <div class="p-3 rounded-xl bg-blue-100 text-blue-700">
          <i class="fas fa-cloud-sun text-xl"></i>
        </div>
        <div>
          <div class="text-sm text-slate-500" id="weatherLabel">Weather Index</div>
          <div class="text-2xl font-bold">72%</div>
        </div>
      </div>
      
      <div class="dashboard-card flex items-center gap-4">
        <div class="p-3 rounded-xl bg-purple-100 text-purple-700">
          <i class="fas fa-rupee-sign text-xl"></i>
        </div>
        <div>
          <div class="text-sm text-slate-500" id="marketLabel">Market Trends</div>
          <div class="text-2xl font-bold">+5.2%</div>
        </div>
      </div>
    </div>

    <!-- Layout -->
    <div class="grid grid-cols-3 gap-6">
      <!-- LEFT: Capture & Controls -->
      <div class="col-span-1 space-y-6">
        <div class="dashboard-card">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-semibold text-lg" id="leftTitle">Crop Health Analysis</h2>
            <span class="small-muted">AI-powered detection</span>
          </div>

          <div id="previewWrap" class="w-full h-64 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200 flex items-center justify-center overflow-hidden mb-4 cursor-pointer">
            <div id="previewPlaceholder" class="text-center p-4">
              <i class="fas fa-cloud-upload-alt text-3xl text-slate-400 mb-2"></i>
              <p class="text-sm text-slate-400" id="uploadText">Click to upload or drag & drop</p>
              <p class="text-xs text-slate-500 mt-1" id="uploadNote">Multiple images supported (max 5MB total, 2MB each)</p>
            </div>
          </div>

          <div class="flex gap-2 mb-4">
            <input id="fileInput" type="file" accept="image/*" class="hidden" multiple />
            <button id="btnUpload" class="btn-primary flex-1">
              <i class="fas fa-upload"></i> <span id="uploadBtnText">Upload Image</span>
            </button>
            <button id="btnSample" class="btn-outline">
              <i class="fas fa-vial"></i> <span id="sampleBtnText">Use Sample</span>
            </button>
          </div>

          <div class="mb-4">
            <label class="text-sm font-medium block mb-2" id="cropTypeLabel">Crop Type</label>
            <select id="cropInput" class="input">
              <option value="">Select crop type</option>
              <option value="Tomato">Tomato</option>
              <option value="Potato">Potato</option>
              <option value="Rice">Rice</option>
              <option value="Wheat">Wheat</option>
              <option value="Cotton">Cotton</option>
              <option value="Sugarcane">Sugarcane</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="mb-4">
            <label class="text-sm font-medium block mb-2" id="confidenceLabel">Confidence threshold: <span id="confLabel">70%</span></label>
            <input id="confRange" type="range" min="50" max="95" value="70" class="w-full" /> 
          </div>

          <div class="flex items-center justify-between gap-3 mb-4">
            <label class="flex items-center gap-2 text-sm cursor-pointer">
              <input id="consent" type="checkbox" checked class="rounded"/>
              <span id="consentLabel">Allow anonymous learning</span>
            </label>
            <button id="btnDetect" class="btn-primary">
              <i class="fas fa-magic"></i> <span id="detectBtnText">Detect Issues</span>
            </button>
          </div>

          <div id="progressWrap" class="mt-4 hidden">
            <div class="text-xs text-slate-500 mb-2 flex justify-between">
              <span id="progressText">Running on-device model…</span>
              <span id="progressPercent">0%</span>
            </div>
            <div class="progress-bar">
              <div id="progressBar" class="progress-bar-fill w-0"></div>
            </div>
          </div>
        </div>

        <!-- Weather Forecast Widget -->
        <div class="dashboard-card">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold" id="weatherTitle">Weather Forecast</h3>
            <div class="text-xs text-slate-500" id="weatherLocation">Lucknow, UP</div>
          </div>
          <div id="weatherContainer" class="space-y-3">
            <div class="weather-card">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-2xl font-bold" id="currentTemp">32°C</div>
                  <div class="text-sm" id="weatherCondition">Partly Cloudy</div>
                </div>
                <div class="text-right">
                  <div class="text-sm">Humidity: <span id="weatherHumidity">65%</span></div>
                  <div class="text-sm">Rain: <span id="weatherRain">10%</span></div>
                </div>
              </div>
            </div>
            <div class="flex justify-between text-xs text-center">
              <div class="px-2">
                <div>Today</div>
                <div class="font-semibold">32°</div>
              </div>
              <div class="px-2">
                <div>Tomorrow</div>
                <div class="font-semibold">34°</div>
              </div>
              <div class="px-2">
                <div>Wed</div>
                <div class="font-semibold">33°</div>
              </div>
              <div class="px-2">
                <div>Thu</div>
                <div class="font-semibold">31°</div>
              </div>
            </div>
          </div>
          <div class="mt-3 text-xs text-slate-500" id="weatherAdvice">Good weather for spraying treatments.</div>
        </div>

        <div class="dashboard-card space-y-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold" id="sessionTitle">Session Stats</h3>
            <div class="text-xs text-slate-500">Realtime</div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="p-3 rounded-lg bg-emerald-50">
              <div class="text-sm text-slate-600" id="detectionCountLabel">Detections</div>
              <div id="statDetections" class="text-xl font-bold">0</div>
            </div>
            <div class="p-3 rounded-lg bg-amber-50">
              <div class="text-sm text-slate-600" id="flagsLabel">Flags</div>
              <div id="statFlags" class="text-xl font-bold">0</div>
            </div>
          </div>

          <div>
            <h4 class="text-sm font-medium mb-2" id="historyLabel">History</h4>
            <div id="historyList" class="max-h-36 overflow-auto space-y-2 text-sm"></div>
            <div class="flex gap-2 mt-3">
              <button id="btnExportCSV" class="btn-outline flex-1">
                <i class="fas fa-file-csv"></i> <span id="exportBtnText">Export CSV</span>
              </button>
              <button id="btnClearHistory" class="btn-outline text-red-600">
                <i class="fas fa-trash"></i> <span id="clearBtnText">Clear</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- MIDDLE: Results & Tabs -->
      <div class="col-span-1 space-y-6">
        <div class="dashboard-card">
          <div class="flex items-start justify-between">
            <div>
              <h3 class="font-semibold text-lg" id="resultsHeading">Result & Advisory</h3>
              <p id="resultSub" class="text-sm text-slate-500">Upload & detect to see result</p>
            </div>
            <div id="badges" class="flex flex-col items-end gap-2"></div>
          </div>

          <div id="resultCard" class="mt-4 hidden">
            <div class="flex items-center gap-3 mb-4">
              <div id="detectedName" class="font-semibold text-emerald-700 text-lg"></div>
              <div id="tagCrop" class="badge"></div>
              <div id="tagConf" class="badge bg-blue-100 text-blue-800"></div>
              <button id="btnSpeak" class="ml-auto btn-outline">
                <i class="fas fa-volume-up"></i> <span id="speakBtnText">Speak</span>
              </button>
            </div>

            <!-- Disease Severity Indicator -->
            <div class="mb-4">
              <div class="flex items-center justify-between mb-1">
                <span class="text-sm font-medium" id="severityLabel">Disease Severity</span>
                <span class="text-xs" id="severityValue">Moderate (45%)</span>
              </div>
              <div class="severity-indicator">
                <div id="severityFill" class="severity-fill bg-amber-500" style="width: 45%"></div>
              </div>
            </div>

            <div>
              <div class="flex gap-2 border-b pb-2 overflow-x-auto">
                <button class="tab-btn tab-active" data-tab="advisory">
                  <i class="fas fa-lightbulb"></i> <span id="advisoryTabText">Advisory</span>
                </button>
                <button class="tab-btn" data-tab="symptoms">
                  <i class="fas fa-stethoscope"></i> <span id="symptomsTabText">Symptoms</span>
                </button>
                <button class="tab-btn" data-tab="stores">
                  <i class="fas fa-store"></i> <span id="storesTabText">Nearby Stores</span>
                </button>
                <button class="tab-btn" data-tab="pesticide">
                  <i class="fas fa-calculator"></i> <span id="pesticideTabText">Spray Calculator</span>
                </button>
              </div>

              <div id="tabContent" class="mt-3">
                <div id="advisory" class="tab-pane">
                  <ul id="advList" class="list-disc pl-5 space-y-2"></ul>
                </div>
                <div id="symptoms" class="tab-pane hidden">
                  <ul id="symList" class="list-disc pl-5 space-y-2"></ul>
                </div>
                <div id="stores" class="tab-pane hidden">
                  <div id="storesList"></div>
                  <div id="map" class="w-full h-40 rounded-xl mt-3 border"></div>
                </div>
                <div id="pesticide" class="tab-pane hidden">
                  <div class="text-sm mb-3" id="pesticideCalcText">Calculate required pesticide quantity for your field</div>
                  <div class="space-y-3">
                    <div>
                      <label class="text-sm font-medium" id="fieldAreaLabel">Field Area (acres)</label>
                      <input type="number" id="fieldArea" class="input mt-1" placeholder="e.g., 2.5" value="1" min="0.1" step="0.1">
                    </div>
                    <div>
                      <label class="text-sm font-medium" id="dosageLabel">Recommended dosage</label>
                      <input type="text" id="recommendedDosage" class="input mt-1 bg-gray-100" value="2g/L" readonly>
                    </div>
                    <div class="pesticide-card bg-slate-50 p-3 rounded-lg">
                      <div class="text-sm font-medium" id="pesticideNeededText">You will need approximately:</div>
                      <div id="pesticideResult" class="font-bold text-lg mt-1">200g</div>
                      <div class="text-xs text-slate-500 mt-1" id="pesticideNote">For spraying at 200L/acre</div>
                    </div>
                    <button id="btnCalculatePesticide" class="btn-primary w-full">
                      <i class="fas fa-calculator"></i> <span id="calculateBtnText">Calculate</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 gap-3 mt-4">
              <textarea id="notes" placeholder="Notes (field, spray dates)" class="input h-24"></textarea>
              <div class="flex gap-2">
                <button id="btnPdf" class="btn-primary flex-1">
                  <i class="fas fa-file-pdf"></i> <span id="pdfBtnText">Download PDF</span>
                </button>
                <button id="btnFlag" class="btn-outline">
                  <i class="fas fa-flag"></i> <span id="flagBtnText">Flag wrong detection</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Crop Calendar Widget -->
        <div class="dashboard-card">
          <div class="flex items-center justify-between mb-4">
            <h4 class="font-medium" id="calendarTitle">Crop Calendar</h4>
            <div class="text-xs text-slate-500" id="currentMonth">August 2023</div>
          </div>
          <div class="grid grid-cols-7 gap-1 text-xs text-center mb-2">
            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
          </div>
          <div class="grid grid-cols-7 gap-1" id="cropCalendar">
            <!-- Calendar will be generated by JavaScript -->
          </div>
          <div class="mt-3 text-xs text-slate-500" id="calendarNote">Click on dates to mark important events</div>
        </div>

        <div class="dashboard-card">
          <div class="flex items-center justify-between">
            <div>
              <h4 class="font-medium" id="advancedTitle">Advanced</h4>
              <p class="text-xs text-slate-500" id="advancedSubtitle">Experimental features</p>
            </div>
            <label class="flex items-center gap-2 text-sm cursor-pointer">
              <input id="darkToggle" type="checkbox" />
              <span id="darkModeText">Dark UI</span>
            </label>
          </div>

          <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
            <button id="btnShareAdvisory" class="btn-outline">
              <i class="fas fa-share"></i> <span id="shareAdvisoryText">Share Advisory</span>
            </button>
            <button id="btnSaveImage" class="btn-outline">
              <i class="fas fa-save"></i> <span id="saveImageText">Save Image</span>
            </button>
            <button id="btnAnalyze" class="btn-primary">
              <i class="fas fa-chart-line"></i> <span id="analyzeBtnText">Generate Report</span>
            </button>
            <button id="btnApiSim" class="btn-outline">
              <i class="fas fa-cloud-upload-alt"></i> <span id="apiSimText">Simulate Upload</span>
            </button>
          </div>
        </div>
      </div>

      <!-- RIGHT: Analytics & Pitch -->
      <div class="col-span-1 space-y-6">
        <div class="dashboard-card">
          <h4 class="font-medium mb-4" id="analyticsTitle">Analytics</h4>
          <div class="h-48 relative">
            <canvas id="diseaseChart"></canvas>
          </div>
          <div class="mt-4 grid grid-cols-2 gap-3">
            <div class="p-3 rounded-lg bg-emerald-50">
              <div class="text-xs text-slate-600" id="avgConfLabel">Avg Confidence</div>
              <div id="avgConf" class="text-lg font-bold">0%</div>
            </div>
            <div class="p-3 rounded-lg bg-sky-50">
              <div class="text-xs text-slate-600" id="uniqueCropsLabel">Unique Crops</div>
              <div id="uniqueCrops" class="text-lg font-bold">0</div>
            </div>
          </div>
        </div>

        <!-- Market Prices Widget -->
        <div class="dashboard-card">
          <div class="flex items-center justify-between mb-4">
            <h4 class="font-medium" id="marketTitle">Market Prices</h4>
            <div class="text-xs text-slate-500" id="marketSubtitle">Local mandi</div>
          </div>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <div class="text-sm">Tomato</div>
              <div class="font-semibold">₹1,800/q</div>
              <div class="text-xs text-emerald-600">+12%</div>
            </div>
            <div class="flex justify-between items-center">
              <div class="text-sm">Potato</div>
              <div class="font-semibold">₹1,200/q</div>
              <div class="text-xs text-rose-600">-5%</div>
            </div>
            <div class="flex justify-between items-center">
              <div class="text-sm">Rice</div>
              <div class="font-semibold">₹2,500/q</div>
              <div class="text-xs text-emerald-600">+3%</div>
            </div>
          </div>
          <div class="market-price-trend mt-3">
            <canvas id="priceChart" height="60"></canvas>
          </div>
          <div class="text-xs text-slate-500 mt-2" id="marketUpdateLabel">Last updated: <span id="marketUpdateTime">Today 9:30 AM</span></div>
        </div>

        <!-- Government Schemes Widget -->
        <div class="dashboard-card">
          <div class="flex items-center justify-between mb-4">
            <h4 class="font-medium" id="schemesTitle">Government Schemes</h4>
            <div class="text-xs text-slate-500" id="schemesSubtitle">Latest Updates</div>
          </div>
          <div id="schemesContainer" class="space-y-3">
            <!-- Schemes will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Floating Chat Assistant -->
    <div class="chat-container hidden" id="chatbotContainer">
      <div class="chat-header">
        <div>
          <div class="font-semibold">Chat With FarmGuru </div>
          <div class="text-xs opacity-80">Ask me about Farming</div>
        </div>
        <div class="flex gap-2">
          <button class="lang-btn active" data-lang="en">EN</button>
          <button class="lang-btn" data-lang="hi">HI</button>
          <button class="lang-btn" data-lang="ml">ML</button>
          <button class="lang-btn" data-lang="te">TE</button>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="message bot-message">
          Hello! I'm your AI farming assistant. How can I help you today?
        </div>
      </div>
      <div class="chat-input-container">
        <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
        <button class="voice-btn" id="voiceBtn">
          <i class="fas fa-microphone"></i>
        </button>
        <button class="btn-primary" id="sendBtn">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>

    <div class="chat-toggle" id="chatToggle">
      <i class="fas fa-comments"></i>
    </div>

    <footer class="text-center mt-8 text-xs text-slate-500 py-4 border-t">
      FarmGuru AI • Hackathon Prototype • Built for demonstration purposes
    </footer>
  </div>

  <script>
  (function(){
    // === Mock DB & samples ===
    const DISEASE_DB = [
      {
        id: "tomato_leaf_curl",
        crop: "Tomato",
        name_en: "Tomato Leaf Curl Virus",
        name_hi: "टमाटर लीफ कर्ल वायरस",
        name_ml: "തക്കാളി ഇല വളയുന്ന വൈറസ്",
        name_te: "టమాటా ఆకు కర్ల్ వైరస్",
        name_mr: "टोमॅटो लीफ कर्ल व्हायरस",
        symptoms_en: ["Upward curling of leaves", "Stunted growth", "Yellowing between veins"],
        symptoms_hi: ["पत्तों का ऊपर की ओर मुड़ना", "विकास रुकना", "नसों के बीच पीलापन"],
        symptoms_ml: ["ഇലകൾ മുകളിലേക്ക് വളയുന്നു", "വളർച്ച കുറയുന്നു", "സിരകൾക്കിടയിൽ മഞ്ഞനിറം"],
        symptoms_te: ["ఆకులు పైకి వంకరతో", "పెరుగుదల నిలిచిపోవడం", "సిరల మధ్య పసుపు రంగు"],
        symptoms_mr: ["पाने वरच्या दिशेने वाकणे", "वाढ खुंटणे", "शिरांमध्ये पिवळेपणा"],
        treatment_en: ["Spray Neem oil 3ml/L water (repeat after 7 days)", "Remove heavily infected plants", "Use yellow sticky traps to control whitefly vectors"],
        treatment_hi: ["नीम तेल 3ml/लीटर पानी में स्प्रे करें (7 दिन बाद दोहराएँ)", "बहुत संक्रमित पौधों को हटा दें", "व्हाइटफ्लाई नियंत्रण के लिए पीले स्टिकी ट्रैप लगाएँ"],
        treatment_ml: ["നീം ഓയിൽ 3ml/ലിറ്റർ വെള്ളത്തിൽ സ്പ്രേ ചെയ്യുക (7 ദിവസത്തിന് ശേഷം ആവർത്തിക്കുക)", "കടുത്ത രോഗബാധിത ചെടികൾ നീക്കം ചെയ്യുക", "വൈറ്റ്ഫ്ലൈ നിയന്ത്രണത്തിന് മഞ്ഞ സ്റ്റിക്കി ട്രാപ്പുകൾ ഉപയോഗിക്കുക"],
        treatment_te: ["నీమ్ ఆయిల్ 3ml/లీటరు నీటిలో స్ప్రే చేయండి (7 రోజుల తర్వాత పునరావృతం చేయండి)", "అత్యంత సోకిన మొక్కలను తీసివేయండి", "వైట్ ఫ్లై వెక్టర్స్ నియంత్రణకు పసుపు స్టికీ ట్రాప్లను ఉపయోగించండి"],
        treatment_mr: ["कडुलिंब तेल 3ml/लीटर पाण्यात फवारणी करा (7 दिवसांनी पुन्हा करा)", "जास्त संसर्ग झालेली रोपे काढून टाका", "व्हाइटफ्लाय नियंत्रणासाठी पिवळे स्टिकी ट्रॅप वापरा"],
        severity: 65
      },
      {
        id: "potato_early_blight",
        crop: "Potato",
        name_en: "Early Blight",
        name_hi: "अर्ली ब्लाइट",
        name_ml: "ആദ്യകാല ബ്ലൈറ്റ്",
        name_te: "అర్లీ బ్లైట్",
        name_mr: "अर्ली ब्लाइट",
        symptoms_en: ["Dark concentric rings on leaves", "Brown lesions"],
        symptoms_hi: ["पत्तों पर गोल-गोल काले छल्ले", "भूरे धब्बे"],
        symptoms_ml: ["ഇലകളിൽ ഇരുണ്ട കേന്ദ്രീകൃത വളയങ്ങൾ", "തവിട്ടു നിറത്തിലുള്ള പുണ്ണുകൾ"],
        symptoms_te: ["ఆకులపై నల్లని కేంద్రిక వలయాలు", "బ్రౌన్ లెషన్స్"],
        symptoms_mr: ["पान्यावर गडद केंद्रित रिंग", "तपकिरी फोड"],
        treatment_en: ["Spray Mancozeb 2g/L or Chlorothalonil as per label", "Remove debris; follow 3-year crop rotation"],
        treatment_hi: ["मैनकोजेब 2g/लीटर या क्लोरोथालोनिल लेबल अनुसार स्प्रे करें", "कचरा हटाएँ; 3 साल की फसल चक्र अपनाएँ"],
        treatment_ml: ["ലേബൽ പ്രകാരം മാൻകോസെബ് 2g/ലിറ്റർ അല്ലെങ്കിൽ ക്ലോറോത്തലോണിൽ സ്പ്രേ ചെയ്യുക", "ചവറ് നീക്കം ചെയ്യുക; 3 വർഷത്തെ കൃഷി ചക്രം പാലിക്കുക"],
        treatment_te: ["లేబల్ ప్రకారం మ్యాన్కోజెబ్ 2g/లీటరు లేదా క్లోరోతలోనిల్ స్ప్రే చేయండి", "చెత్తను తీసివేయండి; 3-సంవత్సరాల పంట భ్రమణాన్ని అనుసరించండి"],
        treatment_mr: ["मॅन्कोझेब 2g/लीटर किंवा क्लोरोथालोनिल लेबल प्रमाणे फवारणी करा", "कचरा काढून टाका; 3 वर्षांचे पीक चक्र पाळा"],
        severity: 45
      }
    ];

    const SAMPLE_IMAGES = {
      tomato_leaf_curl: "https://images.unsplash.com/photo-1566843971944-0296e7c58b05?auto=format&fit=crop&w=600&q=80",
      potato_early_blight: "https://images.unsplash.com/photo-1602540663439-5b9b2a3e6468?auto=format&fit=crop&w=600&q=80",
      rice_blast: "https://images.unsplash.com/photo-1501004318641-b39e6451bec6?auto=format&fit=crop&w=600&q=80"
    };

    // Chatbot knowledge base
    const CHATBOT_KB = {
      en: {
        greeting: ["Hello! I'm your AI farming assistant. How can I help you today?"],
        farewell: ["Goodbye! Feel free to come back with more questions."],
        thanks: ["You're welcome! Happy to help a fellow farmer."],
        questions: {
          "organic pest control": "For organic pest control, try neem oil spray (5ml per liter), garlic-chili spray, or introducing beneficial insects like ladybugs.",
          "best time to water plants": "The best time to water plants is early morning before 10am.",
          "tomato fertilizer schedule": "Tomatoes need fertilizer at planting time, when first fruits appear, and every 4-6 weeks during growing season."
        },
        fallback: ["I'm not sure about that. Could you try asking in a different way?"]
      },
      hi: {
        greeting: ["नमस्ते! मैं आपकी AI कृषि सहायक हूं। आज मैं आपकी कैसे मदद कर सकती हूं?"],
        farewell: ["अलविदा! जब भी सवाल हों, पूछने में संकोच न करें।"],
        thanks: ["आपका स्वागत है! एक साथी किसान की मदद करके खुशी हुई।"],
        questions: {
          "organic pest control": "जैविक कीट नियंत्रण के लिए, नीम का तेल स्प्रे (5ml प्रति लीटर) का उपयोग करें।",
          "best time to water plants": "पौधों को पानी देने का सबसे अच्छा समय सुबह 10 बजे से पहले का है।"
        },
        fallback: ["मुझे इस बारे में यकीन नहीं है। क्या आप इसे अलग तरीके से पूछने की कोशिश कर सकते हैं?"]
      }
    };

    // Language translations for UI elements
    const UI_TRANSLATIONS = {
      en: {
        appTitle: "FarmGuru AI",
        appSubtitle: "Intelligent Crop Advisory System · Hackathon Prototype",
        shareText: "Share",
        detectionLabel: "Detections Today",
        alertsLabel: "Disease Alerts",
        weatherLabel: "Weather Index",
        marketLabel: "Market Trends",
        leftTitle: "Crop Health Analysis",
        uploadText: "Click to upload or drag & drop",
        uploadNote: "Multiple images supported (max 5MB total, 2MB each)",
        uploadBtnText: "Upload Image",
        sampleBtnText: "Use Sample",
        cropTypeLabel: "Crop Type",
        confidenceLabel: "Confidence threshold:",
        consentLabel: "Allow anonymous learning",
        detectBtnText: "Detect Issues",
        weatherTitle: "Weather Forecast",
        sessionTitle: "Session Stats",
        detectionCountLabel: "Detections",
        flagsLabel: "Flags",
        historyLabel: "History",
        exportBtnText: "Export CSV",
        clearBtnText: "Clear",
        resultsHeading: "Result & Advisory",
        speakBtnText: "Speak",
        severityLabel: "Disease Severity",
        advisoryTabText: "Advisory",
        symptomsTabText: "Symptoms",
        storesTabText: "Nearby Stores",
        pesticideTabText: "Spray Calculator",
        pesticideCalcText: "Calculate required pesticide quantity for your field",
        fieldAreaLabel: "Field Area (acres)",
        dosageLabel: "Recommended dosage",
        pesticideNeededText: "You will need approximately:",
        pesticideNote: "For spraying at 200L/acre",
        calculateBtnText: "Calculate",
        pdfBtnText: "Download PDF",
        flagBtnText: "Flag wrong detection",
        calendarTitle: "Crop Calendar",
        calendarNote: "Click on dates to mark important events",
        advancedTitle: "Advanced",
        advancedSubtitle: "Experimental features",
        darkModeText: "Dark UI",
        shareAdvisoryText: "Share Advisory",
        saveImageText: "Save Image",
        analyzeBtnText: "Generate Report",
        apiSimText: "Simulate Upload",
        analyticsTitle: "Analytics",
        avgConfLabel: "Avg Confidence",
        uniqueCropsLabel: "Unique Crops",
        marketTitle: "Market Prices",
        marketSubtitle: "Local mandi",
        marketUpdateLabel: "Last updated:",
        schemesTitle: "Government Schemes",
        schemesSubtitle: "Latest Updates"
      },
      hi: {
        appTitle: "फार्मगुरु AI",
        appSubtitle: "बुद्धिमान फसल सलाह प्रणाली · हैकाथॉन प्रोटोटाइप",
        shareText: "साझा करें",
        detectionLabel: "आज की पहचान",
        alertsLabel: "रोग अलर्ट",
        weatherLabel: "मौसम सूचकांक",
        marketLabel: "बाजार रुझान",
        leftTitle: "फसल स्वास्थ्य विश्लेषण",
        uploadText: "अपलोड करने के लिए क्लिक करें या खींचें और छोड़ें",
        uploadNote: "कई चित्र समर्थित (अधिकतम 5MB कुल, 2MB प्रत्येक)",
        uploadBtnText: "चित्र अपलोड करें",
        sampleBtnText: "नमूना उपयोग करें",
        cropTypeLabel: "फसल प्रकार",
        confidenceLabel: "विश्वास सीमा:",
        consentLabel: "अनामिक शिक्षण की अनुमति दें",
        detectBtnText: "समस्याएं पहचानें",
        weatherTitle: "मौसम पूर्वानुमान",
        sessionTitle: "सत्र आंकड़े",
        detectionCountLabel: "पहचान",
        flagsLabel: "ध्वजांकित",
        historyLabel: "इतिहास",
        exportBtnText: "CSV निर्यात करें",
        clearBtnText: "साफ करें",
        resultsHeading: "परिणाम और सलाह",
        speakBtnText: "बोलें",
        severityLabel: "रोग गंभीरता",
        advisoryTabText: "सलाह",
        symptomsTabText: "लक्षण",
        storesTabText: "निकटतम स्टोर",
        pesticideTabText: "स्प्रे कैलकुलेटर",
        pesticideCalcText: "अपने खेत के लिए आवश्यक कीटनाशक मात्रा की गणना करें",
        fieldAreaLabel: "खेत का क्षेत्रफल (एकड़)",
        dosageLabel: "अनुशंसित खुराक",
        pesticideNeededText: "आपको लगभग चाहिए:",
        pesticideNote: "200L/एकड़ की दर से छिड़काव के लिए",
        calculateBtnText: "गणना करें",
        pdfBtnText: "PDF डाउनलोड करें",
        flagBtnText: "गलत पहचान को ध्वजांकित करें",
        calendarTitle: "फसल कैलेंडर",
        calendarNote: "महत्वपूर्ण घटनाओं को चिह्नित करने के लिए तिथियों पर क्लिक करें",
        advancedTitle: "उन्नत",
        advancedSubtitle: "प्रायोगिक सुविधाएं",
        darkModeText: "डार्क UI",
        shareAdvisoryText: "सलाह साझा करें",
        saveImageText: "चित्र सहेजें",
        analyzeBtnText: "रिपोर्ट जनरेट करें",
        apiSimText: "अपलोड सिम्युलेट करें",
        analyticsTitle: "विश्लेषिकी",
        avgConfLabel: "औसत विश्वास",
        uniqueCropsLabel: "अद्वितीय फसलें",
        marketTitle: "बाजार मूल्य",
        marketSubtitle: "स्थानीय मंडी",
        marketUpdateLabel: "अंतिम अपडेट:",
        schemesTitle: "सरकारी योजनाएं",
        schemesSubtitle: "नवीनतम अपडेट"
      }
    };

    // === DOM refs ===
    const fileInput = document.getElementById("fileInput");
    const btnUpload = document.getElementById("btnUpload");
    const btnSample = document.getElementById("btnSample");
    const previewWrap = document.getElementById("previewWrap");
    const previewPlaceholder = document.getElementById("previewPlaceholder");
    const btnDetect = document.getElementById("btnDetect");
    const cropInput = document.getElementById("cropInput");
    const confRange = document.getElementById("confRange");
    const confLabel = document.getElementById("confLabel");
    const progressWrap = document.getElementById("progressWrap");
    const progressBar = document.getElementById("progressBar");
    const progressPercent = document.getElementById("progressPercent");
    const progressText = document.getElementById("progressText");
    const resultCard = document.getElementById("resultCard");
    const detectedName = document.getElementById("detectedName");
    const tagCrop = document.getElementById("tagCrop");
    const tagConf = document.getElementById("tagConf");
    const advList = document.getElementById("advList");
    const symList = document.getElementById("symList");
    const storesList = document.getElementById("storesList");
    const mapEl = document.getElementById("map");
    const btnSpeak = document.getElementById("btnSpeak");
    const langSelect = document.getElementById("langSelect");
    const statDetections = document.getElementById("statDetections");
    const statFlags = document.getElementById("statFlags");
    const historyList = document.getElementById("historyList");
    const diseaseChartCtx = document.getElementById("diseaseChart");
    const avgConf = document.getElementById("avgConf");
    const uniqueCrops = document.getElementById("uniqueCrops");
    const severityFill = document.getElementById("severityFill");
    const severityValue = document.getElementById("severityValue");
    const fieldArea = document.getElementById("fieldArea");
    const recommendedDosage = document.getElementById("recommendedDosage");
    const pesticideResult = document.getElementById("pesticideResult");
    const btnCalculatePesticide = document.getElementById("btnCalculatePesticide");
    const cropCalendar = document.getElementById("cropCalendar");
    const currentMonth = document.getElementById("currentMonth");
    const chatbotContainer = document.getElementById("chatbotContainer");
    const chatToggle = document.getElementById("chatToggle");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const voiceBtn = document.getElementById("voiceBtn");
    const sendBtn = document.getElementById("sendBtn");
    const langButtons = document.querySelectorAll(".lang-btn");
    const currentTemp = document.getElementById("currentTemp");
    const weatherCondition = document.getElementById("weatherCondition");
    const weatherHumidity = document.getElementById("weatherHumidity");
    const weatherRain = document.getElementById("weatherRain");
    const weatherAdvice = document.getElementById("weatherAdvice");
    const notification = document.getElementById("notification");
    const notificationIcon = document.getElementById("notificationIcon");
    const notificationTitle = document.getElementById("notificationTitle");
    const notificationMessage = document.getElementById("notificationMessage");
    const schemesContainer = document.getElementById("schemesContainer");
    const marketUpdateTime = document.getElementById("marketUpdateTime");
    const priceChartCtx = document.getElementById("priceChart");

    // State variables
    let currentImages = [];
    let currentResult = null;
    let session = { detections: [], flags: 0 };
    let leafletMap = null;
    let diseaseChart = null;
    let priceChart = null;
    let chatLang = "en";
    let isListening = false;
    let recognition = null;

    // Market data for real-time trends
    const marketData = {
      crops: [
        { name: "Tomato", price: 1800, change: 12, trend: "up" },
        { name: "Potato", price: 1200, change: -5, trend: "down" },
        { name: "Rice", price: 2500, change: 3, trend: "up" }
      ],
      history: []
    };

    // Government schemes data
    const GOVERNMENT_SCHEMES = [
      {
        title: "PM-KISAN Scheme",
        description: "Financial assistance of ₹6,000 per year to all farmer families.",
        deadline: "31-Dec-2024",
        category: "Financial"
      },
      {
        title: "Soil Health Card Scheme",
        description: "Get your soil tested and receive recommendations for nutrients.",
        deadline: "Ongoing",
        category: "Technical"
      },
      {
        title: "Pradhan Mantri Fasal Bima Yojana",
        description: "Crop insurance against natural calamities at low premium.",
        deadline: "30-Nov-2024",
        category: "Insurance"
      }
    ];

    // Initialize the application
    function init() {
      setupEventListeners();
      updateOnline();
      confLabel.textContent = confRange.value + "%";
      confRange.addEventListener("input", () => confLabel.textContent = confRange.value + "%");
      loadSession();
      updateAnalytics();
      generateCalendar();
      updateWeather();
      initChatbot();
      initGovernmentSchemes();
      initMarketTrends();
      
      if (!session.detections.length) {
        const sample = DISEASE_DB[0];
        session.detections.push({ 
          id: sample.id, 
          crop: sample.crop, 
          conf: 82, 
          time: new Date().toISOString() 
        });
        saveSession(); 
        renderHistory(); 
        updateStats(); 
        updateAnalytics();
      }
      
      showNotification("Welcome to FarmGuru AI", "Your intelligent crop advisory system is ready!", "success");
    }

    // === LANGUAGE SWITCHING FUNCTIONALITY ===
    function updateUILanguage(lang) {
      const translations = UI_TRANSLATIONS[lang] || UI_TRANSLATIONS.en;
      
      // Update all UI elements with translations
      document.getElementById('appTitle').textContent = translations.appTitle;
      document.getElementById('appSubtitle').textContent = translations.appSubtitle;
      document.getElementById('shareText').textContent = translations.shareText;
      document.getElementById('detectionLabel').textContent = translations.detectionLabel;
      document.getElementById('alertsLabel').textContent = translations.alertsLabel;
      document.getElementById('weatherLabel').textContent = translations.weatherLabel;
      document.getElementById('marketLabel').textContent = translations.marketLabel;
      document.getElementById('leftTitle').textContent = translations.leftTitle;
      document.getElementById('uploadText').textContent = translations.uploadText;
      document.getElementById('uploadNote').textContent = translations.uploadNote;
      document.getElementById('uploadBtnText').textContent = translations.uploadBtnText;
      document.getElementById('sampleBtnText').textContent = translations.sampleBtnText;
      document.getElementById('cropTypeLabel').textContent = translations.cropTypeLabel;
      document.getElementById('confidenceLabel').innerHTML = translations.confidenceLabel;
      document.getElementById('consentLabel').textContent = translations.consentLabel;
      document.getElementById('detectBtnText').textContent = translations.detectBtnText;
      document.getElementById('weatherTitle').textContent = translations.weatherTitle;
      document.getElementById('sessionTitle').textContent = translations.sessionTitle;
      document.getElementById('detectionCountLabel').textContent = translations.detectionCountLabel;
      document.getElementById('flagsLabel').textContent = translations.flagsLabel;
      document.getElementById('historyLabel').textContent = translations.historyLabel;
      document.getElementById('exportBtnText').textContent = translations.exportBtnText;
      document.getElementById('clearBtnText').textContent = translations.clearBtnText;
      document.getElementById('resultsHeading').textContent = translations.resultsHeading;
      document.getElementById('speakBtnText').textContent = translations.speakBtnText;
      document.getElementById('severityLabel').textContent = translations.severityLabel;
      document.getElementById('advisoryTabText').textContent = translations.advisoryTabText;
      document.getElementById('symptomsTabText').textContent = translations.symptomsTabText;
      document.getElementById('storesTabText').textContent = translations.storesTabText;
      document.getElementById('pesticideTabText').textContent = translations.pesticideTabText;
      document.getElementById('pesticideCalcText').textContent = translations.pesticideCalcText;
      document.getElementById('fieldAreaLabel').textContent = translations.fieldAreaLabel;
      document.getElementById('dosageLabel').textContent = translations.dosageLabel;
      document.getElementById('pesticideNeededText').textContent = translations.pesticideNeededText;
      document.getElementById('pesticideNote').textContent = translations.pesticideNote;
      document.getElementById('calculateBtnText').textContent = translations.calculateBtnText;
      document.getElementById('pdfBtnText').textContent = translations.pdfBtnText;
      document.getElementById('flagBtnText').textContent = translations.flagBtnText;
      document.getElementById('calendarTitle').textContent = translations.calendarTitle;
      document.getElementById('calendarNote').textContent = translations.calendarNote;
      document.getElementById('advancedTitle').textContent = translations.advancedTitle;
      document.getElementById('advancedSubtitle').textContent = translations.advancedSubtitle;
      document.getElementById('darkModeText').textContent = translations.darkModeText;
      document.getElementById('shareAdvisoryText').textContent = translations.shareAdvisoryText;
      document.getElementById('saveImageText').textContent = translations.saveImageText;
      document.getElementById('analyzeBtnText').textContent = translations.analyzeBtnText;
      document.getElementById('apiSimText').textContent = translations.apiSimText;
      document.getElementById('analyticsTitle').textContent = translations.analyticsTitle;
      document.getElementById('avgConfLabel').textContent = translations.avgConfLabel;
      document.getElementById('uniqueCropsLabel').textContent = translations.uniqueCropsLabel;
      document.getElementById('marketTitle').textContent = translations.marketTitle;
      document.getElementById('marketSubtitle').textContent = translations.marketSubtitle;
      document.getElementById('marketUpdateLabel').innerHTML = translations.marketUpdateLabel;
      document.getElementById('schemesTitle').textContent = translations.schemesTitle;
      document.getElementById('schemesSubtitle').textContent = translations.schemesSubtitle;
      
      // Update result card if there's a current result
      if (currentResult) {
        displayDetectionResult();
      }
    }

    // === MULTI-IMAGE UPLOAD FUNCTIONALITY ===
    function handleFileUpload(e) {
      const files = e.target.files;
      if (!files || files.length === 0) return;
      
      const totalSize = Array.from(files).reduce((total, file) => total + file.size, 0);
      const maxSize = 5 * 1024 * 1024;
      
      if (totalSize > maxSize) {
        showNotification("Size limit exceeded", `Total size ${(totalSize/1024/1024).toFixed(2)}MB exceeds 5MB limit`, "error");
        e.target.value = "";
        return;
      }
      
      for (let file of files) {
        if (file.size > 2 * 1024 * 1024) {
          showNotification("File too large", `${file.name} is ${(file.size/1024/1024).toFixed(2)}MB (max 2MB each)`, "error");
          e.target.value = "";
          return;
        }
      }
      
      previewPlaceholder.classList.add("hidden");
      previewWrap.innerHTML = "";
      
      const imageGrid = document.createElement("div");
      imageGrid.className = "image-grid";
      
      currentImages = [];
      
      Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          currentImages.push({
            src: e.target.result,
            name: file.name,
            size: file.size,
            type: file.type
          });
          
          const imgContainer = document.createElement("div");
          imgContainer.className = "image-item";
          
          const img = document.createElement("img");
          img.src = e.target.result;
          img.alt = `Uploaded crop image ${index + 1}`;
          
          img.addEventListener('click', () => {
            showImageModal(e.target.result, file.name);
          });
          
          const fileInfo = document.createElement("div");
          fileInfo.className = "image-info";
          fileInfo.innerHTML = `${file.name}<br>${(file.size/1024).toFixed(1)}KB`;
          
          const removeBtn = document.createElement("button");
          removeBtn.className = "absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center opacity-70 hover:opacity-100 transition-opacity";
          removeBtn.innerHTML = "×";
          removeBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            currentImages.splice(index, 1);
            imgContainer.remove();
            updateFileSummary();
            if (currentImages.length === 0) {
              previewPlaceholder.classList.remove("hidden");
              previewWrap.innerHTML = previewPlaceholder.outerHTML;
            }
          });
          
          imgContainer.appendChild(img);
          imgContainer.appendChild(fileInfo);
          imgContainer.appendChild(removeBtn);
          imageGrid.appendChild(imgContainer);
        };
        reader.readAsDataURL(file);
      });
      
      previewWrap.appendChild(imageGrid);
      updateFileSummary();
      
      showNotification("Images uploaded", `${files.length} image(s) ready for analysis`, "success");
    }

    function updateFileSummary() {
      const existingSummary = previewWrap.querySelector('.file-summary');
      if (existingSummary) existingSummary.remove();
      
      if (currentImages.length > 0) {
        const totalSize = currentImages.reduce((sum, img) => sum + img.size, 0);
        const fileInfo = document.createElement("div");
        fileInfo.className = "file-summary";
        fileInfo.innerHTML = `
          <div class="flex justify-center items-center gap-4">
            <span>📸 ${currentImages.length} image(s)</span>
            <span>💾 ${(totalSize/1024/1024).toFixed(2)}MB</span>
            <button id="clearAllBtn" class="text-red-500 hover:text-red-700">Clear All</button>
          </div>
        `;
        previewWrap.appendChild(fileInfo);
        
        document.getElementById('clearAllBtn').addEventListener('click', () => {
          currentImages = [];
          previewPlaceholder.classList.remove("hidden");
          previewWrap.innerHTML = previewPlaceholder.outerHTML;
        });
      }
    }

    function showImageModal(src, filename) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg max-w-4xl max-h-full overflow-auto">
          <div class="p-4 border-b flex justify-between items-center">
            <h3 class="font-semibold">${filename}</h3>
            <button class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
          </div>
          <div class="p-4">
            <img src="${src}" alt="${filename}" class="max-w-full h-auto">
          </div>
        </div>
      `;
      
      modal.querySelector('button').addEventListener('click', () => modal.remove());
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      
      document.body.appendChild(modal);
    }

    function useSampleImage() {
      const sampleKeys = Object.keys(SAMPLE_IMAGES);
      const numSamples = Math.min(3, Math.floor(Math.random() * 3) + 2);
      
      previewPlaceholder.classList.add("hidden");
      previewWrap.innerHTML = "";
      
      const imageGrid = document.createElement("div");
      imageGrid.className = "image-grid";
      
      currentImages = [];
      
      for (let i = 0; i < numSamples; i++) {
        const randomSample = sampleKeys[Math.floor(Math.random() * sampleKeys.length)];
        const sampleUrl = SAMPLE_IMAGES[randomSample];
        
        currentImages.push({
          src: sampleUrl,
          name: `sample_${i+1}.jpg`,
          size: Math.floor(Math.random() * 500000) + 100000,
          type: 'image/jpeg'
        });
        
        const imgContainer = document.createElement("div");
        imgContainer.className = "image-item";
        
        const img = document.createElement("img");
        img.src = sampleUrl;
        img.alt = `Sample image ${i + 1}`;
        img.className = "w-full h-20 object-cover rounded-lg cursor-pointer";
        
        img.addEventListener('click', () => {
          showImageModal(sampleUrl, `sample_${i+1}.jpg`);
        });
        
        const fileInfo = document.createElement("div");
        fileInfo.className = "image-info";
        fileInfo.textContent = `sample_${i+1}.jpg • ${(currentImages[i].size/1024).toFixed(1)}KB`;
        
        imgContainer.appendChild(img);
        imgContainer.appendChild(fileInfo);
        imageGrid.appendChild(imgContainer);
      }
      
      previewWrap.appendChild(imageGrid);
      updateFileSummary();
      
      const firstSampleKey = sampleKeys.find(key => SAMPLE_IMAGES[key] === currentImages[0].src);
      const disease = DISEASE_DB.find(d => d.id === firstSampleKey);
      if (disease) {
        cropInput.value = disease.crop;
      }
      
      showNotification("Samples loaded", `${numSamples} sample images loaded for testing`, "info");
    }

    function detectDiseases() {
      if (!currentImages || currentImages.length === 0) {
        showNotification("No images", "Please upload images first", "error");
        return;
      }
      
      if (!cropInput.value) {
        showNotification("Crop type required", "Please select the crop type", "error");
        return;
      }
      
      progressWrap.classList.remove("hidden");
      let progress = 0;
      const totalImages = currentImages.length;
      
      const interval = setInterval(() => {
        const imagesProcessed = Math.floor((progress / 100) * totalImages);
        progressText.textContent = `Analyzing ${imagesProcessed + 1} of ${totalImages} images...`;
        
        progress += (100 / (totalImages * 2));
        progressBar.style.width = `${Math.min(progress, 100)}%`;
        progressPercent.textContent = `${Math.round(Math.min(progress, 100))}%`;
        
        if (progress >= 100) {
          clearInterval(interval);
          processDetectionResult();
        }
      }, 200);
    }

    // === ENHANCED NEARBY STORES ===
    function updateNearbyStores() {
      const stores = [
        { 
          name: "Kisan Agri Clinic", 
          distance: "2.3 km", 
          rating: "4.2",
          pesticides: ["Neem Oil", "Mancozeb", "Chlorothalonil"],
          unavailable: ["Bio pesticides"],
          lat: 26.8467,
          lng: 80.9462,
          phone: "+91 9876543210",
          timing: "8:00 AM - 8:00 PM"
        },
        { 
          name: "Krishi Seva Kendra", 
          distance: "3.1 km", 
          rating: "4.5",
          pesticides: ["Neem Oil", "Bio pesticides", "Fungicides"],
          unavailable: ["Specialized herbicides"],
          lat: 26.8567,
          lng: 80.9562,
          phone: "+91 9876543211",
          timing: "9:00 AM - 7:00 PM"
        }
      ];
      
      storesList.innerHTML = "";
      stores.forEach((store, index) => {
        const storeCard = document.createElement("div");
        storeCard.className = "store-card bg-gray-50 rounded-lg p-3 mb-2 cursor-pointer hover:bg-green-50 transition-colors";
        storeCard.innerHTML = `
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="font-semibold text-green-700">${store.name}</div>
              <div class="text-xs text-gray-600">${store.distance} away • ${store.rating} ★</div>
              <div class="text-xs text-gray-600">📞 ${store.phone}</div>
              <div class="text-xs text-gray-600">🕒 ${store.timing}</div>
              
              <div class="mt-2">
                <div class="text-xs font-medium text-green-600">Available:</div>
                <div class="flex flex-wrap gap-1 mt-1">
                  ${store.pesticides.map(p => `<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">${p}</span>`).join('')}
                </div>
              </div>
            </div>
            <button class="bg-green-500 text-white p-2 rounded-lg text-xs directions-btn" data-index="${index}">
              <i class="fas fa-directions"></i>
            </button>
          </div>
        `;
        
        storeCard.addEventListener('click', () => {
          showStoreDetails(store);
        });
        
        storesList.appendChild(storeCard);
      });
      
      document.querySelectorAll('.directions-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const index = parseInt(btn.dataset.index);
          showDirections(stores[index]);
        });
      });
      
      initAdvancedMap(stores);
    }

    function initAdvancedMap(stores) {
      if (leafletMap) {
        leafletMap.remove();
      }
      
      leafletMap = L.map(mapEl).setView([26.8467, 80.9462], 12);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(leafletMap);
      
      const markerColors = ['green', 'blue'];
      
      stores.forEach((store, index) => {
        const customIcon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="background-color: ${markerColors[index]}; width: 25px; height: 25px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"></div>`,
          iconSize: [25, 25],
          iconAnchor: [12, 12]
        });
        
        const marker = L.marker([store.lat, store.lng], {icon: customIcon}).addTo(leafletMap);
        
        marker.bindPopup(`
          <div class="p-2">
            <strong>${store.name}</strong><br>
            Distance: ${store.distance}<br>
            Rating: ${store.rating} ★<br>
            <button class="bg-green-500 text-white px-3 py-1 rounded mt-2 text-sm details-btn">View Details</button>
          </div>
        `);
      });
    }

    function showStoreDetails(store) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg max-w-md w-full mx-4">
          <div class="p-4 border-b flex justify-between items-center">
            <h3 class="font-semibold text-lg">${store.name}</h3>
            <button class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
          </div>
          <div class="p-4 max-h-96 overflow-y-auto">
            <div class="space-y-3">
              <div><strong>Distance:</strong> ${store.distance}</div>
              <div><strong>Rating:</strong> ${store.rating} ★</div>
              <div><strong>Phone:</strong> ${store.phone}</div>
              <div><strong>Timing:</strong> ${store.timing}</div>
              
              <div>
                <strong>Available Pesticides:</strong>
                <div class="mt-2 grid grid-cols-2 gap-2">
                  ${store.pesticides.map(p => `
                    <div class="bg-green-50 border border-green-200 rounded p-2 text-center">
                      <div class="text-green-700 font-medium">${p}</div>
                      <div class="text-green-600 text-xs">In Stock</div>
                    </div>
                  `).join('')}
                </div>
              </div>
              
              <div class="flex gap-2 mt-4">
                <button class="flex-1 bg-green-500 text-white py-2 rounded directions-btn">
                  <i class="fas fa-directions"></i> Get Directions
                </button>
                <button class="flex-1 bg-blue-500 text-white py-2 rounded call-btn">
                  <i class="fas fa-phone"></i> Call Now
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      modal.querySelector('button').addEventListener('click', () => modal.remove());
      modal.querySelector('.directions-btn').addEventListener('click', () => {
        showDirections(store);
        modal.remove();
      });
      modal.querySelector('.call-btn').addEventListener('click', () => {
        window.open(`tel:${store.phone}`);
      });
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      
      document.body.appendChild(modal);
    }

    function showDirections(store) {
      showNotification("Directions", `Opening directions to ${store.name} in maps app`, "info");
      setTimeout(() => {
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${store.lat},${store.lng}`, '_blank');
      }, 1000);
    }

    // === ENHANCED WEATHER SYSTEM ===
    function updateWeather() {
      const weatherConditions = [
        { 
          temp: 32, condition: "Sunny", humidity: 65, rain: 10, 
          advice: "Perfect weather for spraying. Low wind conditions ideal for pesticide application.",
          icon: "☀️"
        },
        { 
          temp: 28, condition: "Partly Cloudy", humidity: 70, rain: 30,
          advice: "Good for light farming activities. Avoid spraying if rain expected within 6 hours.",
          icon: "⛅"
        }
      ];
      
      const weather = weatherConditions[Math.floor(Math.random() * weatherConditions.length)];
      
      currentTemp.textContent = `${weather.temp}°C`;
      weatherCondition.textContent = weather.condition;
      weatherHumidity.textContent = `${weather.humidity}%`;
      weatherRain.textContent = `${weather.rain}%`;
      weatherAdvice.textContent = weather.advice;
      
      const weatherCard = document.querySelector('.weather-card');
      weatherCard.innerHTML = `
        <div class="flex items-center justify-between">
          <div>
            <div class="text-4xl mb-2">${weather.icon}</div>
            <div class="text-2xl font-bold">${weather.temp}°C</div>
            <div class="text-sm">${weather.condition}</div>
          </div>
          <div class="text-right">
            <div class="text-sm">Humidity: <span>${weather.humidity}%</span></div>
            <div class="text-sm">Rain: <span>${weather.rain}%</span></div>
            <div class="text-sm mt-2">🌬️ Wind: 8 km/h</div>
          </div>
        </div>
        <div class="mt-3 p-2 bg-white bg-opacity-20 rounded text-xs">
          <strong>Farmers Advice:</strong> ${weather.advice}
        </div>
      `;
    }

    // === GOVERNMENT SCHEMES ===
        function initGovernmentSchemes() {
      schemesContainer.innerHTML = "";
      
      GOVERNMENT_SCHEMES.forEach(scheme => {
        const schemeEl = document.createElement("div");
        schemeEl.className = "scheme-item bg-slate-50 rounded-lg p-3 border-l-4 border-blue-500 cursor-pointer transition-transform hover:translate-x-1";
        schemeEl.innerHTML = `
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="font-semibold text-blue-700">${scheme.title}</div>
              <div class="text-xs text-slate-600 mt-1">${scheme.description}</div>
              <div class="flex items-center gap-2 mt-2">
                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">${scheme.category}</span>
                <span class="text-xs text-slate-500">Deadline: ${scheme.deadline}</span>
              </div>
            </div>
            <button class="text-blue-500 hover:text-blue-700 text-lg details-btn">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        `;
        
        schemeEl.addEventListener('click', () => {
          showSchemeDetails(scheme);
        });
        
        schemesContainer.appendChild(schemeEl);
      });
    }

    function showSchemeDetails(scheme) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg max-w-md w-full mx-4">
          <div class="p-4 border-b flex justify-between items-center">
            <h3 class="font-semibold text-lg">${scheme.title}</h3>
            <button class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
          </div>
          <div class="p-4 max-h-96 overflow-y-auto">
            <div class="space-y-4">
              <div>
                <strong>Description:</strong>
                <p class="mt-1 text-sm">${scheme.description}</p>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                <div class="bg-blue-50 p-3 rounded-lg">
                  <div class="text-xs text-blue-600">Category</div>
                  <div class="font-semibold">${scheme.category}</div>
                </div>
                <div class="bg-green-50 p-3 rounded-lg">
                  <div class="text-xs text-green-600">Deadline</div>
                  <div class="font-semibold">${scheme.deadline}</div>
                </div>
              </div>
              
              <div class="bg-yellow-50 p-3 rounded-lg">
                <div class="text-xs text-yellow-700 font-semibold">How to Apply:</div>
                <ul class="text-sm mt-1 list-disc pl-4 space-y-1">
                  <li>Visit your nearest agriculture office</li>
                  <li>Carry required documents (Aadhaar, land records)</li>
                  <li>Fill the application form</li>
                  <li>Submit to concerned authority</li>
                </ul>
              </div>
              
              <div class="flex gap-2">
                <button class="flex-1 bg-blue-500 text-white py-2 rounded apply-btn">
                  <i class="fas fa-file-alt"></i> Apply Online
                </button>
                <button class="flex-1 bg-green-500 text-white py-2 rounded website-btn">
                  <i class="fas fa-globe"></i> Official Website
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      modal.querySelector('button').addEventListener('click', () => modal.remove());
      modal.querySelector('.apply-btn').addEventListener('click', () => {
        showNotification("Application", "Redirecting to online application portal...", "info");
        setTimeout(() => {
          window.open('https://agriculture.gov.in', '_blank');
        }, 1000);
      });
      modal.querySelector('.website-btn').addEventListener('click', () => {
        window.open('https://agriculture.gov.in', '_blank');
      });
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      
      document.body.appendChild(modal);
    }

    // === MARKET TRENDS ===
    function initMarketTrends() {
      // Generate price history for chart
      const basePrice = 1800;
      marketData.history = Array.from({length: 7}, (_, i) => 
        basePrice + Math.sin(i * 0.8) * 200 + Math.random() * 100
      );
      
      // Update market update time
      marketUpdateTime.textContent = `Today ${new Date().getHours()}:${new Date().getMinutes().toString().padStart(2, '0')} AM`;
      
      // Initialize price chart
      if (priceChartCtx) {
        priceChart = new Chart(priceChartCtx, {
          type: 'line',
          data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Today'],
            datasets: [{
              label: 'Tomato Price (₹/q)',
              data: marketData.history,
              borderColor: '#10B981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              borderWidth: 2,
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: false,
                grid: {
                  display: false
                },
                ticks: {
                  display: false
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            },
            elements: {
              point: {
                radius: 0
              }
            }
          }
        });
      }
    }

    // === PROCESS DETECTION RESULT ===
    function processDetectionResult() {
      progressText.textContent = "Finalizing results...";
      
      setTimeout(() => {
        progressWrap.classList.add("hidden");
        
        // Simulate AI detection result
        const randomDisease = DISEASE_DB[Math.floor(Math.random() * DISEASE_DB.length)];
        const confidence = Math.floor(Math.random() * 20) + 75; // 75-95%
        
        currentResult = {
          disease: randomDisease,
          confidence: confidence,
          timestamp: new Date().toISOString(),
          images: currentImages.length
        };
        
        // Update session
        session.detections.push({
          id: randomDisease.id,
          crop: cropInput.value,
          conf: confidence,
          time: currentResult.timestamp
        });
        saveSession();
        
        // Display results
        displayDetectionResult();
        updateStats();
        updateAnalytics();
        renderHistory();
        
        showNotification("Analysis Complete", `Detected ${randomDisease.name_en} with ${confidence}% confidence`, "success");
      }, 800);
    }

    function displayDetectionResult() {
      if (!currentResult) return;
      
      const disease = currentResult.disease;
      const lang = langSelect.value;
      
      resultCard.classList.remove("hidden");
      detectedName.textContent = disease[`name_${lang}`] || disease.name_en;
      tagCrop.textContent = disease.crop;
      tagConf.textContent = `${currentResult.confidence}% Confident`;
      
      // Update severity
      const severity = disease.severity;
      severityFill.style.width = `${severity}%`;
      severityValue.textContent = severity >= 70 ? `High (${severity}%)` : 
                                 severity >= 40 ? `Moderate (${severity}%)` : `Low (${severity}%)`;
      severityFill.className = `severity-fill ${severity >= 70 ? 'bg-red-500' : severity >= 40 ? 'bg-amber-500' : 'bg-green-500'}`;
      
      // Update advisory
      const treatments = disease[`treatment_${lang}`] || disease.treatment_en;
      advList.innerHTML = treatments.map(t => `<li>${t}</li>`).join('');
      
      // Update symptoms
      const symptoms = disease[`symptoms_${lang}`] || disease.symptoms_en;
      symList.innerHTML = symptoms.map(s => `<li>${s}</li>`).join('');
      
      // Update nearby stores
      updateNearbyStores();
      
      // Update pesticide calculator
      recommendedDosage.value = severity >= 70 ? "3g/L" : severity >= 40 ? "2g/L" : "1g/L";
      calculatePesticide();
    }

    function calculatePesticide() {
      const area = parseFloat(fieldArea.value) || 1;
      const dosage = recommendedDosage.value;
      const rate = parseFloat(dosage);
      const waterPerAcre = 200; // liters
      const totalPesticide = area * waterPerAcre * rate;
      
      pesticideResult.textContent = `${totalPesticide}g`;
    }

    // === CHATBOT FUNCTIONALITY ===
    function initChatbot() {
      // Toggle chatbot visibility
      chatToggle.addEventListener('click', () => {
        chatbotContainer.classList.toggle('hidden');
      });
      
      // Language switching
      langButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          langButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          chatLang = btn.dataset.lang;
        });
      });
      
      // Send message
      sendBtn.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });
      
      // Voice input
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = false;
        recognition.interimResults = false;
        
        recognition.onstart = () => {
          isListening = true;
          voiceBtn.classList.add('listening');
        };
        
        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          chatInput.value = transcript;
          isListening = false;
          voiceBtn.classList.remove('listening');
        };
        
        recognition.onerror = () => {
          isListening = false;
          voiceBtn.classList.remove('listening');
        };
        
        recognition.onend = () => {
          isListening = false;
          voiceBtn.classList.remove('listening');
        };
        
        voiceBtn.addEventListener('click', () => {
          if (isListening) {
            recognition.stop();
          } else {
            recognition.lang = chatLang === 'en' ? 'en-IN' : 'hi-IN';
            recognition.start();
          }
        });
      } else {
        voiceBtn.style.display = 'none';
      }
    }

    function sendMessage() {
      const message = chatInput.value.trim();
      if (!message) return;
      
      // Add user message
      addMessage(message, 'user');
      chatInput.value = '';
      
      // Simulate AI response
      setTimeout(() => {
        const response = generateChatbotResponse(message, chatLang);
        addMessage(response, 'bot');
      }, 1000);
    }

    function addMessage(text, sender) {
      const messageEl = document.createElement('div');
      messageEl.className = `message ${sender === 'user' ? 'user-message' : 'bot-message'}`;
      messageEl.textContent = text;
      chatMessages.appendChild(messageEl);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function generateChatbotResponse(message, lang) {
      const kb = CHATBOT_KB[lang] || CHATBOT_KB.en;
      const lowerMessage = message.toLowerCase();
      
      // Check for greetings
      if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || lowerMessage.includes('namaste')) {
        return kb.greeting[0];
      }
      
      // Check for farewell
      if (lowerMessage.includes('bye') || lowerMessage.includes('thank')) {
        return kb.thanks[0];
      }
      
      // Check knowledge base
      for (const [key, response] of Object.entries(kb.questions)) {
        if (lowerMessage.includes(key)) {
          return response;
        }
      }
      
      // Fallback response
      return kb.fallback[0];
    }

    // === UTILITY FUNCTIONS ===
    function setupEventListeners() {
      btnUpload.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', handleFileUpload);
      btnSample.addEventListener('click', useSampleImage);
      btnDetect.addEventListener('click', detectDiseases);
      btnSpeak.addEventListener('click', speakAdvisory);
      btnCalculatePesticide.addEventListener('click', calculatePesticide);
      fieldArea.addEventListener('input', calculatePesticide);
      
      // Language selector
      langSelect.addEventListener('change', (e) => {
        updateUILanguage(e.target.value);
      });
      
      // Tab switching
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
          document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
          
          btn.classList.add('tab-active');
          document.getElementById(btn.dataset.tab).classList.remove('hidden');
        });
      });
      
      // Dark mode toggle
      document.getElementById('darkToggle').addEventListener('change', (e) => {
        document.body.classList.toggle('dark', e.target.checked);
      });
      
      // PDF generation
      document.getElementById('btnPdf').addEventListener('click', generatePDF);
      
      // Share functionality
      document.getElementById('shareBtn').addEventListener('click', shareResults);
    }

    function speakAdvisory() {
      if (!currentResult) return;
      
      const disease = currentResult.disease;
      const lang = langSelect.value;
      const text = `${disease[`name_${lang}`] || disease.name_en}. ${(disease[`treatment_${lang}`] || disease.treatment_en).join(' ')}`;
      
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = lang === 'en' ? 'en-IN' : 'hi-IN';
        speechSynthesis.speak(utterance);
      } else {
        showNotification("Voice not supported", "Text-to-speech is not supported in your browser", "warning");
      }
    }

    function generatePDF() {
      if (!currentResult) {
        showNotification("No results", "Please analyze an image first", "error");
        return;
      }
      
      showNotification("PDF Generation", "Preparing your advisory report...", "info");
      
      // Simulate PDF generation
      setTimeout(() => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(20);
        doc.text("FarmGuru AI Advisory Report", 20, 20);
        doc.setFontSize(12);
        doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 30);
        doc.text(`Crop: ${currentResult.disease.crop}`, 20, 40);
        doc.text(`Detection: ${currentResult.disease.name_en}`, 20, 50);
        doc.text(`Confidence: ${currentResult.confidence}%`, 20, 60);
        
        // Add treatments
        doc.text("Recommended Treatments:", 20, 80);
        currentResult.disease.treatment_en.forEach((treatment, index) => {
          doc.text(`• ${treatment}`, 20, 90 + (index * 10));
        });
        
        // Save the PDF
        doc.save(`FarmGuru-Advisory-${new Date().getTime()}.pdf`);
        showNotification("PDF Downloaded", "Your advisory report has been saved", "success");
      }, 1500);
    }

    function shareResults() {
      if (navigator.share) {
        navigator.share({
          title: 'FarmGuru AI Detection',
          text: `I detected ${currentResult ? currentResult.disease.name_en : 'crop issues'} using FarmGuru AI`,
          url: window.location.href
        });
      } else {
        navigator.clipboard.writeText(window.location.href);
        showNotification("Link Copied", "Page URL copied to clipboard", "success");
      }
    }

    function showNotification(title, message, type) {
      notificationTitle.textContent = title;
      notificationMessage.textContent = message;
      
      // Set icon and color based on type
      const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
      };
      
      notification.className = `notification notification-${type}`;
      notificationIcon.className = `fas ${icons[type]}`;
      
      notification.classList.remove('hidden');
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.classList.add('hidden'), 300);
      }, 4000);
    }

    function updateOnline() {
      const onlineDot = document.getElementById('onlineDot');
      const onlineText = document.getElementById('onlineText');
      
      const updateStatus = () => {
        const isOnline = navigator.onLine;
        onlineDot.className = `h-3 w-3 rounded-full block ${isOnline ? 'bg-emerald-500' : 'bg-red-500'}`;
        onlineText.textContent = isOnline ? 'Online' : 'Offline';
      };
      
      window.addEventListener('online', updateStatus);
      window.addEventListener('offline', updateStatus);
      updateStatus();
    }

    function generateCalendar() {
      const now = new Date();
      const month = now.getMonth();
      const year = now.getFullYear();
      
      currentMonth.textContent = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      
      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      cropCalendar.innerHTML = '';
      
      // Add empty cells for days before first day of month
      for (let i = 0; i < firstDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'crop-calendar-day';
        cropCalendar.appendChild(emptyCell);
      }
      
      // Add days of month
      for (let day = 1; day <= daysInMonth; day++) {
        const dayEl = document.createElement('div');
        dayEl.className = 'crop-calendar-day';
        dayEl.textContent = day;
        
        // Mark today
        if (day === now.getDate() && month === now.getMonth()) {
          dayEl.classList.add('today');
        }
        
        // Randomly mark some days as active (farm activities)
        if (Math.random() > 0.7) {
          dayEl.classList.add('active');
        }
        
        dayEl.addEventListener('click', () => {
          dayEl.classList.toggle('active');
        });
        
        cropCalendar.appendChild(dayEl);
      }
    }

    function loadSession() {
      const saved = localStorage.getItem('farmguru_session');
      if (saved) {
        session = JSON.parse(saved);
      }
    }

    function saveSession() {
      localStorage.setItem('farmguru_session', JSON.stringify(session));
    }

    function updateStats() {
      statDetections.textContent = session.detections.length;
      statFlags.textContent = session.flags;
    }

    function renderHistory() {
      historyList.innerHTML = '';
      
      session.detections.slice(-5).forEach(detection => {
        const disease = DISEASE_DB.find(d => d.id === detection.id);
        if (disease) {
          const item = document.createElement('div');
          item.className = 'flex justify-between items-center py-1 border-b border-gray-100';
          item.innerHTML = `
            <div>
              <div class="font-medium">${disease.crop}</div>
              <div class="text-xs text-gray-500">${new Date(detection.time).toLocaleDateString()}</div>
            </div>
            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">${detection.conf}%</span>
          `;
          historyList.appendChild(item);
        }
      });
    }

    function updateAnalytics() {
      if (session.detections.length === 0) {
        avgConf.textContent = '0%';
        uniqueCrops.textContent = '0';
        return;
      }
      
      const avgConfidence = session.detections.reduce((sum, d) => sum + d.conf, 0) / session.detections.length;
      avgConf.textContent = `${Math.round(avgConfidence)}%`;
      
      const uniqueCropsCount = new Set(session.detections.map(d => d.crop)).size;
      uniqueCrops.textContent = uniqueCropsCount;
      
      // Update chart
      if (diseaseChartCtx) {
        const cropCounts = {};
        session.detections.forEach(d => {
          cropCounts[d.crop] = (cropCounts[d.crop] || 0) + 1;
        });
        
        if (diseaseChart) {
          diseaseChart.destroy();
        }
        
        diseaseChart = new Chart(diseaseChartCtx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(cropCounts),
            datasets: [{
              data: Object.values(cropCounts),
              backgroundColor: ['#10B981', '#F59E0B', '#3B82F6', '#EF4444', '#8B5CF6']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }
    }

    // Initialize the application when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>

